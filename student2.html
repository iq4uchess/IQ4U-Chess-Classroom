<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>IQ4U — Student Puzzle</title>

<link rel="stylesheet"
 href="https://cdnjs.cloudflare.com/ajax/libs/chessboard-js/1.0.0/chessboard-1.0.0.min.css"/>

<style>
html,body{height:100%;margin:0;padding:16px;background:#f6f7fb;font-family:Inter,system-ui}
.panel{background:#fff;padding:12px;border-radius:10px;max-width:980px;margin:auto;margin-top:16px}
button{padding:8px 12px;border-radius:8px;border:none;background:#0f172a;color:#fff;cursor:pointer}
#board-wrapper{max-width:760px;margin:auto;padding:16px}
#board{width:100%;aspect-ratio:1/1;min-width:520px;min-height:520px;border-radius:8px}
.notation{margin-top:12px;padding:8px;font-family:monospace;font-size:13px;
border:1px solid #eef2ff;border-radius:6px;min-height:44px;max-height:180px;overflow:auto}
.small{font-size:13px;color:#555}
</style>
</head>

<body>

<script>
if(localStorage.getItem("role")!=="student2"){location.href="index.html";}
</script>

<div class="panel">
  <button id="undoBtn">Undo</button>
  <button id="flipBtn">Flip</button>
  <button id="resignBtn" style="background:#8b0f0f">Resign</button>
  <button id="logoutBtn" style="float:right;background:#dc2626">Logout</button>

  <div style="margin-top:10px;text-align:center">
    <input id="boardSizeRange" type="range" min="360" max="1400" value="760">
    <span id="boardSizeLabel">760px</span>
  </div>

  <div id="board-wrapper"><div id="board"></div></div>
  <div id="msg">Ready</div>
  <div id="movesList" class="notation">No moves yet.</div>
</div>

<div class="panel">
<select id="tacticSelect"><option>Loading…</option></select>
<button id="loadPuzzleBtn">Load</button>
<button id="randomPuzzleBtn">Random</button>

<label>
<input type="checkbox" id="autoOpponent" checked> Auto opponent
</label>

<button id="showSolutionBtn">Show Solution</button>
<button id="resetSolutionBtn">Reset</button>

<select id="solutionSpeed">
<option value="1200">1.2s</option>
<option value="800">0.8s</option>
<option value="500" selected>0.5s</option>
<option value="250">0.25s</option>
</select>

<div id="solutionStatus" class="small">No solution loaded</div>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.12.0/chess.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/chessboard-js/1.0.0/chessboard-1.0.0.min.js"></script>

<script>
const PIECES_BASE="/IQ4U-Chess-Classroom/assets/pieces/cburnett/";
const LIST_URL="/IQ4U-Chess-Classroom/assets/puzzles_list.json";

let board,game=new Chess();
let solutionMoves=[],solutionIndex=0;
let initialSideToMove=null,solutionTimer=null;

function pieceTheme(p){return PIECES_BASE+p+".svg";}

function sanitizeSAN(s){
 return s.replace(/\{.*?\}/g,"")
         .replace(/\$\d+/g,"")
         .replace(/\d+\.+/g,"")
         .replace(/[!?+#]*$/g,"")
         .trim();
}

function refreshNotation(){
 const h=game.history();
 document.getElementById("movesList").textContent=
   h.length?h.join(" "):"No moves yet.";
}

function clearSolutionTimer(){
 if(solutionTimer){clearTimeout(solutionTimer);solutionTimer=null;}
}

function playOpponentMove(){
 clearSolutionTimer();
 if(solutionIndex>=solutionMoves.length) return;
 if(game.turn()!==initialSideToMove) return;

 const delay=parseInt(solutionSpeed.value,10)||500;

 solutionTimer=setTimeout(()=>{
   let raw=solutionMoves[solutionIndex];
   let san=sanitizeSAN(raw);

   if(!san){solutionIndex++;playOpponentMove();return;}

   let mv=game.move(san,{sloppy:true});
   if(!mv){
     console.warn("Skipped invalid SAN:",raw);
     solutionIndex++;
     playOpponentMove();
     return;
   }

   solutionIndex++;
   board.position(game.fen());
   refreshNotation();
   solutionStatus.textContent="Opponent played";

   if(solutionIndex<solutionMoves.length &&
      game.turn()===initialSideToMove){
     playOpponentMove();
   }
 },delay);
}

board=Chessboard("board",{
 draggable:true,
 position:"start",
 pieceTheme,
 onDrop:(s,t)=>{
   let mv=game.move({from:s,to:t,promotion:"q"});
   if(!mv) return "snapback";
   board.position(game.fen());
   refreshNotation();
   if(autoOpponent.checked &&
      game.turn()===initialSideToMove){
     playOpponentMove();
   }
 }
});

fetch(LIST_URL).then(r=>r.json()).then(files=>{
 files.forEach(f=>{
  let o=document.createElement("option");
  o.value=f;o.textContent=f;
  tacticSelect.appendChild(o);
 });
});

showSolutionBtn.onclick=()=>{
 let out="";
 for(let i=0;i<solutionMoves.length;i+=2){
   out+=`${i/2+1}. ${solutionMoves[i]||""} ${solutionMoves[i+1]||""} `;
 }
 movesList.textContent=out.trim();
};

resetSolutionBtn.onclick=refreshNotation;

</script>
</body>
</html>


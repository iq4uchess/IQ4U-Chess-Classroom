<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>IQ4U — Student Puzzle (student2)</title>

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/chessboard-js/1.0.0/chessboard-1.0.0.min.css" />

  <style>
    html,body{ overscroll-behavior-y: contain; height:100%; }
    body{ font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, Arial; margin:16px; background:#f6f7fb; color:#111; display:flex; flex-direction:column; align-items:center; }
    button{ padding:8px 12px; border:none; background:#0f172a; color:#fff; border-radius:8px; cursor:pointer; }
    .panel{ background:#fff; padding:12px; border-radius:10px; margin:0 auto; max-width:980px; width:100%; box-shadow:0 6px 18px rgba(2,6,23,.04); }
    .small{ font-size:13px; color:#555; }
    .muted{ color:#666; font-size:13px; }
    .controls{ display:flex; gap:8px; justify-content:center; }
    #board-wrapper{ width:100%; max-width:760px; display:flex; justify-content:center; padding:16px; }
    #board{ width:100%; aspect-ratio:1/1; min-width:520px; min-height:520px; border:1px solid #e6eefc; border-radius:8px; padding:6px; background:#fff; }
    .notation{ margin-top:12px; padding:8px; border-radius:6px; border:1px solid #eef2ff; background:#fbfdff; min-height:44px; max-height:180px; overflow:auto; font-family:monospace; font-size:13px; }
  </style>
</head>

<body>

<!-- ACCESS CONTROL -->
<script>
(function(){
  const role = localStorage.getItem("role");
  if(!role || role !== "student2"){
    window.location.replace("index.html");
  }
})();
</script>

<div class="panel">
  <div class="controls">
    <button id="undoBtn">Undo</button>
    <button id="flipBtn">Flip</button>
    <button id="resignBtn" style="background:#8b0f0f;">Resign</button>
    <button id="logoutBtn" style="margin-left:auto; background:#dc2626;">Logout</button>
  </div>

  <div style="display:flex; justify-content:center; margin-top:10px;">
    <input id="boardSizeRange" type="range" min="360" max="1400" step="10" value="760">
    <small id="boardSizeLabel" style="margin-left:10px;">760px</small>
  </div>

  <div id="board-wrapper">
    <div id="board"></div>
    <svg id="draw-overlay"></svg>
  </div>

  <div id="msg" class="info">Ready</div>

  <div id="movesList" class="notation">No moves yet.</div>
</div>

<!-- PUZZLE PANEL -->
<div class="panel" style="margin-top:18px;">
  <div style="display:flex; gap:12px; flex-wrap:wrap;">
    <div style="display:flex; gap:8px; align-items:center;">
      <label class="small">Tactic:</label>
      <select id="tacticSelect"><option>Loading…</option></select>

      <label class="small">Min:</label>
      <select id="ratingMin"><option>0</option><option>600</option><option selected>800</option></select>

      <label class="small">Max:</label>
      <select id="ratingMax"><option selected>99999</option><option>1000</option><option>1200</option></select>

      <button id="loadPuzzleBtn">Load</button>
      <button id="randomPuzzleBtn">Random</button>
    </div>

    <div style="margin-left:auto; display:flex; gap:8px;">
      <button id="prevPuzzleBtn">Previous</button>
      <button id="nextPuzzleBtn">Next</button>
      <div id="currentPuzzleId" class="small">No puzzle</div>
    </div>
  </div>

  <div style="display:flex; gap:8px; margin-top:10px;">
    <label><input type="checkbox" id="autoOpponent" checked> <span class="small">Auto opponent</span></label>

    <button id="showSolutionBtn">Show Solution</button>
    <button id="resetSolutionBtn">Reset Solution</button>

    <label class="small">Speed:</label>
    <select id="solutionSpeed">
      <option value="1200">1.2s</option>
      <option value="800">0.8s</option>
      <option value="500" selected>0.5s</option>
    </select>

    <div id="solutionStatus" class="muted small" style="margin-left:auto;">No solution</div>
  </div>
</div>

<!-- MULTIPLAYER -->
<div class="panel" style="margin-top:18px;">
  <div style="display:flex; gap:8px;">
    <label class="small">Username:</label>
    <input id="emailInputBottom" type="text" placeholder="student1">
    <button id="joinBtnBottom">Join Online</button>
  </div>

  <div style="display:flex; gap:8px; margin-top:10px;">
    <div id="multiplayStatus" class="muted small">Not connected</div>
    <div id="pairedBubble" class="status-bubble" style="display:none;">Paired</div>
  </div>
</div>

<!-- PROMOTION MODAL -->
<div id="promoteModal" style="display:none; position:fixed; left:50%; top:50%; transform:translate(-50%,-50%); background:white; padding:12px; border-radius:8px;">
  <div style="font-weight:bold; text-align:center;">Promote to:</div>
  <div style="display:flex; gap:10px; margin-top:10px;">
    <button data-piece="q">Q</button>
    <button data-piece="r">R</button>
    <button data-piece="b">B</button>
    <button data-piece="n">N</button>
  </div>
</div>

<!-- LIBRARIES -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.12.0/chess.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/chessboard-js/1.0.0/chessboard-1.0.0.min.js"></script>

<!-- ================= CORE GAME SCRIPT ================= -->
<script>
(function(){

/* ---------------------------------------------------
   STATE
--------------------------------------------------- */

let board=null;
let game=null;

let solutionMoves=[];
let solutionTypes=[];
let solutionIndex=0;

let initialFen=null;
let initialSideToMove=null;   // OPTION B

let currentList=[];
let currentIdx=-1;

let solutionTimer=null;

/* ---------------------------------------------------
   UI HELPERS
--------------------------------------------------- */

function setMsg(t){
  document.getElementById("msg").textContent=t;
}

function refreshNotation(){
  const moves=game.history();
  const out=document.getElementById("movesList");
  if(!moves.length){ out.textContent="No moves yet."; return; }
  out.textContent=moves.join(" ");
}

/* ---------------------------------------------------
   BOARD SETUP
--------------------------------------------------- */

function createBoard(){
  board = Chessboard("board",{
    draggable:true,
    position:"start",
    onDrop:onDrop,
    onSnapEnd:()=>board.position(game.fen())
  });
}

/* ---------------------------------------------------
   SAN ONLY — SHOW SOLUTION
--------------------------------------------------- */

document.getElementById("showSolutionBtn").onclick = function(){
  if(!solutionMoves.length){
    document.getElementById("movesList").textContent="No solution available.";
    return;
  }

  let txt="";
  for(let i=0;i<solutionMoves.length;i+=2){
    const n=(i/2)+1;
    const w=solutionMoves[i]||"";
    const b=solutionMoves[i+1]||"";
    txt+=`${n}. ${w} ${b} `;
  }

  document.getElementById("movesList").textContent=txt.trim();
  document.getElementById("solutionStatus").textContent="SAN shown";
};

/* ---------------------------------------------------
   RESET SOLUTION (restore notation)
--------------------------------------------------- */

document.getElementById("resetSolutionBtn").onclick = function(){
  refreshNotation();
  document.getElementById("solutionStatus").textContent="Reset";
};

/* ---------------------------------------------------
   STUDENT MOVE HANDLER
--------------------------------------------------- */

async function onDrop(source,target){
  const legal = game.moves({verbose:true});
  const promo = legal.find(m=>m.from===source && m.to===target && m.promotion);

  let chosen=null;
  if(promo){
    chosen=await new Promise(res=>{
      pendingPromotion={resolve:res};
      showPromotion();
    });
  }

  const mv=game.move({from:source,to:target,promotion:chosen});
  if(!mv) return "snapback";

  board.position(game.fen());
  refreshNotation();
}

/* ---------------------------------------------------
   PROMOTION DIALOG
--------------------------------------------------- */

let pendingPromotion=null;
function showPromotion(){ document.getElementById("promoteModal").style.display="block"; }
function hidePromotion(){ document.getElementById("promoteModal").style.display="none"; }

document.getElementById("promoteModal").onclick = function(e){
  if(!e.target.dataset.piece) return;
  if(pendingPromotion) pendingPromotion.resolve(e.target.dataset.piece);
  pendingPromotion=null;
  hidePromotion();
};

/* ---------------------------------------------------
   PUZZLE LOADING
--------------------------------------------------- */

const LIST_URL="/IQ4U-Chess-Classroom/assets/puzzles_list.json";

async function loadList(){
  const r=await fetch(LIST_URL);
  const arr=await r.json();
  window._manifest = arr;
  populateTactics(arr);
}

function populateTactics(list){
  const t = document.getElementById("tacticSelect");
  t.innerHTML='<option value="">— Select tactic —</option>';

  const map={};
  list.forEach(f=>{
    const key=f.replace(".csv","").toLowerCase();
    if(!map[key]) map[key]=[];
    map[key].push(f);
  });

  for(const k in map){
    const op=document.createElement("option");
    op.value=k;
    op.textContent=k+" ("+map[k].length+")";
    t.appendChild(op);
  }

  window._tactics = map;
}

async function buildCandidates(){
  const tactic=document.getElementById("tacticSelect").value;
  if(!tactic){ currentList=[]; return; }

  const files=window._tactics[tactic];
  currentList=[];

  for(const f of files){
    const url="/IQ4U-Chess-Classroom/assets/puzzle/"+f;
    const text=await (await fetch(url)).text();
    const rows=parseCsv(text);

    for(const r of rows){
      currentList.push({row:r,file:f});
    }
  }

  currentIdx=0;
}

function parseCsv(csv){
  csv=csv.replace(/\r/g,"");
  const lines=csv.split("\n");
  const header=lines.shift().split(",").map(h=>h.trim().toLowerCase());
  const out=[];
  for(const ln of lines){
    if(!ln.trim()) continue;
    const parts=ln.split(",");
    const obj={};
    for(let i=0;i<header.length;i++){
      obj[header[i]]=parts[i]?parts[i].trim():"";
    }
    out.push(obj);
  }
  return out;
}

async function loadPuzzle(idx){
  const data=currentList[idx];
  if(!data) return;

  const fen=data.row.fen.trim();
  initialFen=fen;
  game = new Chess(fen);
  board.position(game.fen());

  initialSideToMove = game.turn();  // OPTION-B opponent logic

  const moves = (data.row.san||"").trim().split(/\s+/);
  solutionMoves = moves.filter(v=>v!=="");
  solutionTypes = solutionMoves.map(()=> "san");

  solutionIndex=0;

  refreshNotation();
  document.getElementById("currentPuzzleId").textContent = data.row.puzzleid||"Puzzle";
  document.getElementById("solutionStatus").textContent="Loaded";
}

/* ---------------------------------------------------
   NAV CONTROLS
--------------------------------------------------- */

document.getElementById("loadPuzzleBtn").onclick=async()=>{
  await buildCandidates();
  loadPuzzle(0);
};

document.getElementById("randomPuzzleBtn").onclick=async()=>{
  await buildCandidates();
  const idx=Math.floor(Math.random()*currentList.length);
  loadPuzzle(idx);
};

document.getElementById("nextPuzzleBtn").onclick=()=>{
  if(currentIdx<currentList.length-1){
    currentIdx++;
    loadPuzzle(currentIdx);
  }
};

document.getElementById("prevPuzzleBtn").onclick=()=>{
  if(currentIdx>0){
    currentIdx--;
    loadPuzzle(currentIdx);
  }
};

/* ---------------------------------------------------
   BASIC BUTTONS
--------------------------------------------------- */

document.getElementById("undoBtn").onclick=()=>{
  const mv=game.undo();
  if(mv){
    board.position(game.fen());
    refreshNotation();
  }
};

document.getElementById("flipBtn").onclick=()=>board.flip();

document.getElementById("resignBtn").onclick=()=>{
  game.reset();
  board.position("start");
  refreshNotation();
};

document.getElementById("logoutBtn").onclick=()=>{
  localStorage.removeItem("role");
  window.location.href="index.html";
};

/* ---------------------------------------------------
   BOARD RESIZE
--------------------------------------------------- */

document.getElementById("boardSizeRange").oninput = function(){
  const px=this.value;
  document.getElementById("board-wrapper").style.maxWidth=px+"px";
  document.getElementById("boardSizeLabel").textContent=px+"px";
  board.resize();
};

/* ---------------------------------------------------
   BOOT
--------------------------------------------------- */

(async function boot(){
  game=new Chess();
  createBoard();
  board.position("start");
  await loadList();
  setMsg("Ready");
})();
})();
</script>

<!-- FIREBASE -->
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>

<script>
/* Multiplayer unchanged — omitted for brevity, insert your existing one or request full rebuild */
</script>

</body>
</html>


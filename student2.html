<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>IQ4U — Student Puzzle (student2)</title>

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/chessboard-js/1.0.0/chessboard-1.0.0.min.css" />

  <style>
    html,body{ overscroll-behavior-y: contain; height:100%; }
    body{
      font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, Arial;
      margin:16px;
      background:#f6f7fb;
      color:#111;
      display:flex;
      flex-direction:column;
      align-items:center;
    }
    button{
      padding:8px 12px;
      border:none;
      background:#0f172a;
      color:#fff;
      border-radius:8px;
      cursor:pointer;
    }
    .panel{
      background:#fff;
      padding:12px;
      border-radius:10px;
      box-shadow:0 6px 18px rgba(2,6,23,.04);
      max-width:980px;
      width:100%;
      box-sizing:border-box;
    }
    .controls{
      display:flex;
      gap:8px;
      align-items:center;
    }
    #board-wrapper{
      width:100%;
      max-width:760px;
      margin:12px auto;
      position:relative;
    }
    #board{
      width:100%;
      aspect-ratio:1/1;
      background:#fff;
    }
    .notation{
      margin-top:12px;
      padding:8px;
      border-radius:6px;
      border:1px solid #eef2ff;
      background:#fbfdff;
      min-height:44px;
      max-height:180px;
      overflow:auto;
      font-family:monospace;
      font-size:13px;
      display:flex;
      flex-wrap:wrap;
      gap:8px;
    }
    .cb-last-move{
      outline:3px solid rgba(255,200,0,.95);
      outline-offset:-3px;
    }
    .logout-btn{ background:#dc2626; }
  </style>
</head>

<body>

<!-- ACCESS CHECK -->
<script>
(function(){
  const role = localStorage.getItem('role');
  if(role !== 'student2'){
    location.href = 'index.html';
  }
})();
</script>

<div class="panel">
  <div class="controls">
    <button id="undoBtn">Undo</button>
    <button id="flipBtn">Flip</button>
    <button id="resignBtn" style="background:#8b0f0f;">Resign</button>
    <button id="logoutBtn" class="logout-btn" style="margin-left:auto;">Logout</button>
  </div>

  <div id="board-wrapper">
    <div id="board"></div>
  </div>

  <div id="msg">Ready</div>
  <div id="movesList" class="notation">No moves yet.</div>
</div>

<div class="panel" style="margin-top:12px;">
  <label>Your username:</label>
  <input id="emailInputBottom" />
  <button id="joinBtnBottom">Join Online</button>
  <span id="multiplayStatus">Not connected</span>
</div>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/chessboard-js/1.0.0/chessboard-1.0.0.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.12.0/chess.min.js"></script>

<script>
/* ================= CHESS CORE ================= */

let board, game;

function initBoard(){
  game = new Chess();
  window.game = game; // ★ REQUIRED FOR SPECTATE
  board = Chessboard('board',{
    draggable:true,
    position:'start',
    onDrop:onDrop,
    onSnapEnd:()=>board.position(game.fen())
  });
}

function refreshNotation(){
  const el=document.getElementById('movesList');
  const h=game.history();
  if(!h.length){
    el.textContent='No moves yet.';
    return;
  }
  el.innerHTML='';
  for(let i=0;i<h.length;i+=2){
    el.innerHTML+=`<div>${Math.floor(i/2)+1}. ${h[i]} ${h[i+1]||''}</div>`;
  }
}

function onDrop(from,to){
  const mv=game.move({from,to,promotion:'q'});
  if(!mv) return 'snapback';
  board.position(game.fen());
  refreshNotation();
  emitSpectateFen(); // ★ LIVE STREAM
}

initBoard();
</script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>

<script>
firebase.initializeApp({
  apiKey:"AIzaSyAIefVM1tBjWz35FRWRxmIdEJeO_vpHSKM",
  authDomain:"iq4u-chess-classroom.firebaseapp.com",
  databaseURL:"https://iq4u-chess-classroom-default-rtdb.asia-southeast1.firebasedatabase.app"
});

const db=firebase.database();
let myId=sessionStorage.getItem('iq4u_clientId')||('c_'+Math.random().toString(36).slice(2));
sessionStorage.setItem('iq4u_clientId',myId);
let myEmail='';

function emitSpectateFen(){
  db.ref('spectateFen/'+myId).set(game.fen());
}

function goOnline(email){
  myEmail=email;
  db.ref('online/'+myId).set({
    email, role:'student',
    ts:firebase.database.ServerValue.TIMESTAMP
  });
  setInterval(()=>db.ref('online/'+myId).update({
    ts:firebase.database.ServerValue.TIMESTAMP
  }),25000);
  document.getElementById('multiplayStatus').textContent='Connected as '+email;
}

document.getElementById('joinBtnBottom').onclick=()=>{
  const e=document.getElementById('emailInputBottom').value.trim();
  if(e) goOnline(e);
};
/* ======== SPECTATE INVITES ======== */
db.ref('spectateInvites/'+myId).on('child_added',snap=>{
  const inv=snap.val();
  if(!inv) return;

  const ok=confirm((inv.fromEmail||'Master')+' wants to spectate. Accept?');

  if(inv.fromId){
    db.ref(`spectateResponses/${inv.fromId}/${myId}`).set({
      studentId:myId,
      studentEmail:myEmail,
      accepted:ok,
      boardId:inv.boardId||null,
      fen:ok?game.fen():null,
      ts:firebase.database.ServerValue.TIMESTAMP
    });
    if(ok) emitSpectateFen(); // ★ INITIAL + LIVE
  }
  snap.ref.remove();
});

/* ======== CONTROLS ======== */
undoBtn.onclick=()=>{
  if(game.undo()){
    board.position(game.fen());
    refreshNotation();
    emitSpectateFen();
  }
};
resignBtn.onclick=()=>{
  game.reset();
  board.position('start');
  refreshNotation();
  emitSpectateFen();
};
flipBtn.onclick=()=>board.flip();
logoutBtn.onclick=()=>{
  db.ref('online/'+myId).remove();
  localStorage.clear();
  location.href='index.html';
};
</script>

</body>
</html>


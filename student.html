<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>IQ4U — Student Board (fetch-inject Chess.js)</title>

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/chessboard-js/1.0.0/chessboard-1.0.0.min.css" />
  <style>
    body{ font-family: Arial, sans-serif; margin:16px; background:#f6f7fb; color:#111; }
    .controls{ display:flex; justify-content:flex-end; gap:8px; margin-bottom:12px; }
    button{ padding:8px 12px; border:none; background:#0f172a; color:#fff; border-radius:8px; cursor:pointer; }
    .container{ display:grid; grid-template-columns:420px 1fr; gap:18px; align-items:start; }
    #board{ width:400px; }
    .panel{ background:#fff; padding:12px; border-radius:8px; box-shadow:0 6px 18px rgba(2,6,23,.04); }
    #movesList{ min-height:220px; max-height:300px; overflow:auto; padding:8px; border-radius:6px; background:#fbfdff; border:1px solid #eef2ff; }
    textarea{ width:100%; min-height:120px; padding:8px; border-radius:6px; border:1px solid #e6eefc; font-family:monospace; }
    .status{ padding:10px; border-radius:8px; margin-bottom:12px; }
    .ok{ background:#ecfdf5; border:1px solid #bbf7d0; color:#065f46; }
    .warn{ background:#fff7ed; border:1px solid #ffedd5; color:#92400e; }
    .err{ background:#ffefef; border:1px solid #ffd6d6; color:#7a1f1f; }
    pre.debug{ max-height:200px; overflow:auto; background:#0b1220; color:#9ae6b4; padding:8px; border-radius:6px; }
    @media (max-width:900px){ .container{ grid-template-columns:1fr; } #board{ width:100%; } .controls{ justify-content:center; } }
  </style>
</head>
<body>
  <div id="status" class="status warn">Loading Chess.js from GitHub Pages (fetching)...</div>
  <div id="debug" style="display:none"><strong>Debug info (paste if you need help):</strong><pre class="debug" id="debugText"></pre></div>

  <div class="controls">
    <button id="undoBtn">Undo</button>
    <button id="prevBtn">Previous</button>
    <button id="nextBtn">Next</button>
    <button id="flipBtn">Flip</button>
  </div>

  <div class="container">
    <div class="panel">
      <div id="board"></div>
      <div style="margin-top:10px; display:flex; justify-content:space-between; align-items:center;">
        <div>Orientation:
          <select id="orientationSelect"><option value="white">White</option><option value="black">Black</option></select>
        </div>
        <div>FEN: <code id="fenDisplay" style="font-family:monospace;"></code></div>
      </div>
    </div>

    <div style="display:flex; flex-direction:column; gap:12px;">
      <div class="panel">
        <div style="display:flex; justify-content:space-between; align-items:center;">
          <strong>PGN / FEN Input</strong>
          <button id="loadPgnBtn">Load PGN</button>
        </div>
        <div style="margin-top:8px;">
          <textarea id="pgnInput" placeholder="Paste PGN or FEN here. Example PGN: 1. e4 e5 2. Nf3 Nc6"></textarea>
          <div style="display:flex; gap:8px; margin-top:8px;">
            <button id="clearPgn">Clear</button>
            <button id="loadFenBtn">Load FEN</button>
            <button id="resetBtn">Reset</button>
          </div>
        </div>
      </div>

      <div class="panel">
        <strong>Moves</strong>
        <div id="movesList"></div>
      </div>
    </div>
  </div>

  <script>
  // CONFIG: change this if your path or branch is different
  const CHESS_URL = 'https://iq4uchess.github.io/IQ4U-Chess-Classroom/js/libs/chess.min.js';
  const debugText = document.getElementById('debugText');
  const statusBox = document.getElementById('status');

  function debugLog(msg){
    console.log(msg);
    debugText.textContent += msg + "\\n";
    document.getElementById('debug').style.display = 'block';
  }

  async function fetchAndInjectChess(){
    statusBox.className = 'status warn';
    statusBox.textContent = 'Fetching chess.min.js from: ' + CHESS_URL;
    try{
      const resp = await fetch(CHESS_URL, { cache: 'no-store', mode: 'cors' });
      debugLog('FETCH STATUS: ' + resp.status + ' ' + resp.statusText);
      // print some headers for diagnosis
      try{
        const ct = resp.headers.get('content-type');
        debugLog('Content-Type: ' + ct);
        debugLog('X-Content-Type-Options: ' + (resp.headers.get('x-content-type-options') || 'none'));
      }catch(e){ debugLog('Could not read headers: ' + e.message); }

      if (!resp.ok){
        statusBox.className = 'status err';
        statusBox.textContent = 'Failed to fetch chess.min.js — HTTP ' + resp.status + '. See debug below.';
        const txt = await resp.text().catch(()=>'<no response body>');
        debugLog('RESPONSE BODY:\\n' + txt.slice(0,2000));
        return false;
      }

      const jsText = await resp.text();
      // quick sanity check: does it contain "function Chess" or "Chess" token?
      if (!/Chess/.test(jsText)){
        statusBox.className = 'status warn';
        statusBox.textContent = 'Fetched file but contents look unexpected. See debug.';
        debugLog('Fetched file preview (first 2000 chars):\\n' + jsText.slice(0,2000));
        // still attempt to inject to see real result
      }

      // inject: evaluate the code in global scope
      try{
        // Use Function constructor to create a script in global scope
        // We wrap in IIFE to avoid leaking temporary variables
        new Function(jsText)();
        statusBox.className = 'status ok';
        statusBox.textContent = 'Chess.js injected successfully.';
        debugLog('Chess.js injected. typeof Chess = ' + (typeof Chess));
        return true;
      }catch(execErr){
        statusBox.className = 'status err';
        statusBox.textContent = 'Fetched JS but failed to execute it. See console & debug.';
        debugLog('EXECUTION ERROR: ' + execErr.stack || execErr.message);
        return false;
      }

    }catch(err){
      statusBox.className = 'status err';
      statusBox.textContent = 'Network error while fetching chess.min.js. See debug.';
      debugLog('FETCH ERROR: ' + (err.stack || err.message));
      return false;
    }
  }

  // Load chessboard.js after chess is injected (we append script tag)
  function loadChessboardThenStart(){
    return new Promise((resolve, reject) => {
      if (typeof Chessboard !== 'undefined'){
        resolve();
        return;
      }
      const s = document.createElement('script');
      s.src = 'https://cdnjs.cloudflare.com/ajax/libs/chessboard-js/1.0.0/chessboard-1.0.0.min.js';
      s.async = false;
      s.onload = () => { debugLog('chessboard.js loaded'); resolve(); };
      s.onerror = (e) => { debugLog('Failed to load chessboard.js: ' + e); reject(e); };
      document.head.appendChild(s);
    });
  }

  // Main UI initialization (called after both libs available)
  function initUI(){
    if (typeof Chess === 'undefined'){
      statusBox.className = 'status err';
      statusBox.textContent = 'Chess global not found after injection.';
      debugLog('Chess is undefined — aborting UI init');
      return;
    }
    if (typeof Chessboard === 'undefined'){
      statusBox.className = 'status err';
      statusBox.textContent = 'Chessboard.js not available.';
      debugLog('Chessboard is undefined — aborting UI init');
      return;
    }

    statusBox.className = 'status ok';
    statusBox.textContent = 'Libraries ready. Initializing board...';

    const game = new Chess();
    let board = null;
    let pgnMoves = [];
    let stepIndex = 0;
    let orientation = document.getElementById('orientationSelect').value || 'white';

    function updateFen(){ document.getElementById('fenDisplay').textContent = game.fen(); }
    function refreshMoves(){
      const hist = game.history();
      let html = '';
      if (pgnMoves.length > 0){
        html += '<div style="display:flex;flex-wrap:wrap;gap:6px;margin-bottom:8px">';
        for (let i=0;i<pgnMoves.length;i++){
          const cls = (i < stepIndex) ? 'style="padding:6px;border-radius:6px;background:#e6f0ff;font-weight:600;"' : 'style="padding:6px;border-radius:6px;"';
          html += `<div ${cls}>${pgnMoves[i]}</div>`;
        }
        html += '</div><hr>';
      }
      for (let i=0;i<hist.length;i+=2){
        const no = Math.floor(i/2)+1;
        html += `<div style="padding:6px;border-radius:6px;"><strong>${no}.</strong> ${hist[i]||''} ${hist[i+1]||''}</div>`;
      }
      document.getElementById('movesList').innerHTML = html || '<div>No moves yet.</div>';
    }

    function onDrop(source, target){
      const move = game.move({ from: source, to: target, promotion: 'q' });
      if (move === null) return 'snapback';
      pgnMoves = []; stepIndex = 0;
      updateFen(); refreshMoves();
    }
    function onSnapEnd(){ board.position(game.fen()); }

    function initBoard(){
      board = Chessboard('board', {
        draggable:true, position:'start', orientation:orientation,
        onDrop:onDrop, onSnapEnd:onSnapEnd,
        pieceTheme:'https://cdnjs.cloudflare.com/ajax/libs/chessboard-js/1.0.0/img/chesspieces/wikipedia/{piece}.png'
      });
      updateFen(); refreshMoves();
    }

    document.getElementById('undoBtn').onclick = () => { game.undo(); board.position(game.fen()); updateFen(); refreshMoves(); };
    document.getElementById('flipBtn').onclick = () => { board.flip(); };
    document.getElementById('resetBtn').onclick = () => { game.reset(); pgnMoves=[]; stepIndex=0; board.position('start'); updateFen(); refreshMoves(); };
    document.getElementById('clearPgn').onclick = () => { document.getElementById('pgnInput').value = ''; };
    document.getElementById('orientationSelect').onchange = function(){ orientation = this.value; initBoard(); };

    document.getElementById('loadFenBtn').onclick = () => {
      const txt = document.getElementById('pgnInput').value.trim();
      if (!txt){ alert('Paste FEN first'); return; }
      if (!game.load(txt)){ alert('Invalid FEN'); return; }
      pgnMoves=[]; stepIndex=0; board.position(game.fen()); updateFen(); refreshMoves();
    };

    document.getElementById('loadPgnBtn').onclick = () => {
      const pgn = document.getElementById('pgnInput').value.trim(); if (!pgn){ alert('Paste PGN first'); return; }
      const tmp = new Chess(); let ok=true;
      try { ok = tmp.load_pgn ? tmp.load_pgn(pgn) : tmp.loadPgn ? tmp.loadPgn(pgn) : tmp.load(pgn); } catch(e){ ok=false; }
      if (!ok){ alert('Invalid PGN'); return; }
      pgnMoves = tmp.history(); stepIndex=0; game.reset(); board.position('start'); updateFen(); refreshMoves();
    };

    document.getElementById('nextBtn').onclick = () => {
      if (pgnMoves.length===0 || stepIndex>=pgnMoves.length) return;
      const m = game.move(pgnMoves[stepIndex], { sloppy:true }); if (m===null){ alert('Could not apply move'); return; }
      stepIndex++; board.position(game.fen()); updateFen(); refreshMoves();
    };
    document.getElementById('prevBtn').onclick = () => { if (pgnMoves.length===0 || stepIndex<=0) return; game.undo(); stepIndex--; board.position(game.fen()); updateFen(); refreshMoves(); };

    initBoard();
    window._iq4u = { game, board };
    statusBox.textContent = 'Board ready.';
  }

  // flow: fetch->inject -> load chessboard -> initUI
  (async function(){
    const ok = await fetchAndInjectChess();
    if (!ok){
      debugLog('Aborting: Chess.js not available');
      return;
    }
    try{
      await loadChessboardThenStart();
    }catch(e){
      debugLog('Chessboard load error: ' + e);
      statusBox.className = 'status err';
      statusBox.textContent = 'Failed to load chessboard.js from CDN. Check network/console.';
      return;
    }
    initUI();
  })();
  </script>
</body>
</html>

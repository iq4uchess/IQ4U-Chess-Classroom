<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>IQ4U — Student Board</title>

  <!-- Chessboard CSS -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/chessboard-js/1.0.0/chessboard-1.0.0.min.css" />

  <style>
    body{ font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; margin:16px; background:#f6f7fb; color:#111; }
    .controls{ display:flex; justify-content:flex-end; gap:8px; margin-bottom:12px; }
    button{ padding:8px 12px; border:none; background:#0f172a; color:#fff; border-radius:8px; cursor:pointer; }
    .container{ display:grid; grid-template-columns:420px 1fr; gap:18px; align-items:start; }
    .panel{ background:#fff; padding:12px; border-radius:10px; box-shadow:0 6px 18px rgba(2,6,23,.04); }
    #board-wrapper{ width:420px; height:420px; display:flex; align-items:center; justify-content:center; }
    #board{ width:400px; height:400px; border:1px solid #e6eefc; box-sizing:border-box; background:#fff; }
    #movesList{ min-height:220px; max-height:300px; overflow:auto; padding:8px; border-radius:6px; background:#fbfdff; border:1px solid #eef2ff; }
    textarea{ width:100%; min-height:120px; padding:8px; border-radius:6px; border:1px solid #e6eefc; font-family:monospace; }
    .small{ font-size:13px; color:#555; }
    @media (max-width:900px){ .container{ grid-template-columns:1fr; } #board-wrapper{ width:100%; } #board{ width:100%; height:80vw; max-height:420px; } .controls{ justify-content:center; } }
  </style>
</head>
<body>
  <div class="controls">
    <button id="undoBtn">Undo</button>
    <button id="prevBtn">Previous</button>
    <button id="nextBtn">Next</button>
    <button id="flipBtn">Flip</button>
  </div>

  <div class="container">
    <div class="panel">
      <div id="board-wrapper"><div id="board" aria-label="Chessboard container"></div></div>
      <div style="margin-top:10px; display:flex; justify-content:space-between; align-items:center;">
        <div>Orientation:
          <select id="orientationSelect"><option value="white">White</option><option value="black">Black</option></select>
        </div>
        <div>FEN: <code id="fenDisplay" style="font-family:monospace;"></code></div>
      </div>
    </div>

    <div style="display:flex; flex-direction:column; gap:12px;">
      <div class="panel">
        <div style="display:flex; justify-content:space-between; align-items:center;">
          <strong>PGN / FEN Input</strong>
          <button id="loadPgnBtn">Load PGN</button>
        </div>
        <div style="margin-top:8px;">
          <textarea id="pgnInput" placeholder="Paste PGN or FEN here. Example PGN: 1. e4 e5 2. Nf3 Nc6"></textarea>
          <div style="display:flex; gap:8px; margin-top:8px;">
            <button id="clearPgn">Clear</button>
            <button id="loadFenBtn">Load FEN</button>
            <button id="resetBtn">Reset</button>
          </div>
        </div>
      </div>

      <div class="panel">
        <strong>Moves</strong>
        <div id="movesList"></div>
      </div>
    </div>
  </div>

  <!-- jQuery (optional) -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

  <!-- ✅ PGN PARSER ADDED (your local full parser) -->
  <script src="js/libs/chess-pgn-parser/pgn-parser.js"></script>

  <script>
  (function(){
    const CHESS_URL = 'https://iq4uchess.github.io/IQ4U-Chess-Classroom/js/libs/chess.min.js';
    const CUSTOM_PIECE_THEME = 'https://iq4uchess.github.io/IQ4U-Chess-Classroom/assets/pieces/cburnett/{piece}.svg';
    const FALLBACK_THEME = 'https://cdnjs.cloudflare.com/ajax/libs/chessboard-js/1.0.0/img/chesspieces/wikipedia/{piece}.png';

    async function ensureChess(){
      if (typeof Chess !== 'undefined') return true;
      try{
        const mod = await import(CHESS_URL + '?t=' + Date.now());
        const candidate = mod.default || mod.Chess || mod;
        if (candidate){ window.Chess = candidate; return true; }
      }catch(e){}
      return new Promise(resolve => {
        const s = document.createElement('script');
        s.src = CHESS_URL + '?t=' + Date.now();
        s.onload = () => resolve(typeof Chess !== 'undefined');
        s.onerror = () => resolve(false);
        document.head.appendChild(s);
      });
    }

    function ensureChessboard(){
      return new Promise((res,rej)=>{
        if (typeof Chessboard !== 'undefined') return res();
        const s=document.createElement('script');
        s.src='https://cdnjs.cloudflare.com/ajax/libs/chessboard-js/1.0.0/chessboard-1.0.0.min.js';
        s.onload=()=>res();
        s.onerror=e=>rej(e);
        document.head.appendChild(s);
      });
    }

    function pieceExists(url){
      return fetch(url,{method:'HEAD'}).then(r=>r.ok).catch(()=>false);
    }

    async function chooseTheme(){
      const test=CUSTOM_PIECE_THEME.replace('{piece}','wP');
      const ok = await pieceExists(test);
      return ok ? CUSTOM_PIECE_THEME : FALLBACK_THEME;
    }

    // ===== APP STATE =====
    let game, board, pgnMoves=[], stepIndex=0;
    function updateFen(){ document.getElementById('fenDisplay').textContent = game.fen(); }

    function refreshMoves(){
      const hist=game.history();
      let html='';
      for(let i=0;i<hist.length;i+=2){
        const no=Math.floor(i/2)+1;
        html+=`<div style="padding:4px 0;"><strong>${no}.</strong> ${hist[i]||''} ${hist[i+1]||''}</div>`;
      }
      document.getElementById('movesList').innerHTML = html || '<div class="small">No moves yet.</div>';
    }

    function onDrop(source,target){
      const move = game.move({from:source,to:target,promotion:'q'});
      if(!move) return 'snapback';
      pgnMoves=[]; stepIndex=0;
      updateFen(); refreshMoves();
    }
    function onSnapEnd(){ board.position(game.fen()); }

    function createBoard(theme){
      const ori=document.getElementById('orientationSelect').value;
      if(board && board.destroy) board.destroy();
      board=Chessboard('board',{
        draggable:true, position:'start', orientation:ori,
        onDrop:onDrop, onSnapEnd:onSnapEnd, pieceTheme:theme
      });
    }

    // ============================
    // ⭐ NEW: FULL PGN PARSE LOGIC
    // ============================
    function loadPGN_withParser(pgn){
      try{
        if(typeof parser==='undefined' || typeof parser.pgn2json!=='function'){
          throw new Error("Parser not loaded");
        }

        const json = parser.pgn2json(pgn);
        const data = JSON.parse(json);

        // Reset game
        game.reset();

        // Handle header FEN if exists
        if (data.str && data.str.FEN && data.str.SetUp === "1") {
          try { game.load(data.str.FEN); } catch(e){}
        }

        // Apply SAN moves
        const moves = data.moves.filter(m => m && m.trim());
        for (const san of moves){
          try { game.move(san, { sloppy:true }); }
          catch(e){ console.warn("Move failed:", san); break; }
        }

        updateFen();
        refreshMoves();
      }catch(e){
        console.error("PGN parser failed → fallback:", e);
        return false; // signal failure
      }
      return true; // signal success
    }

    // ==================
    // UI AND CONTROLS
    // ==================
    function wireUI(){
      document.getElementById('undoBtn').onclick = () => {
        game.undo(); board.position(game.fen()); updateFen(); refreshMoves();
      };
      document.getElementById('flipBtn').onclick = () => board.flip();
      document.getElementById('resetBtn').onclick = () => {
        game.reset(); pgnMoves=[]; stepIndex=0; board.position('start'); updateFen(); refreshMoves();
      };
      document.getElementById('clearPgn').onclick = () => { document.getElementById('pgnInput').value=''; };

      document.getElementById('orientationSelect').onchange = function(){ createBoard(currentTheme); };

      document.getElementById('loadFenBtn').onclick = () => {
        const fen=document.getElementById('pgnInput').value.trim();
        if(!fen){ alert("Paste FEN"); return; }
        if(!game.load(fen)){ alert("Invalid FEN"); return; }
        pgnMoves=[]; stepIndex=0;
        board.position(game.fen()); updateFen(); refreshMoves();
      };

      // ⭐ UPDATED LOAD PGN BUTTON
      document.getElementById('loadPgnBtn').onclick = () => {
        const pgn=document.getElementById('pgnInput').value.trim();
        if(!pgn){ alert("Paste PGN"); return; }

        // 1) TRY FULL PGN PARSER
        const ok = loadPGN_withParser(pgn);
        if (ok) return;

        // 2) FALLBACK — chess.js built-in loader
        const tmp=new Chess(); let success=true;
        try{ success = tmp.load_pgn ? tmp.load_pgn(pgn) : tmp.load(pgn); }catch(e){ success=false; }
        if(!success){ alert("Invalid PGN"); return; }

        pgnMoves = tmp.history();
        game.reset(); board.position('start');
        updateFen(); refreshMoves();
      };

      // PGN navigation
      document.getElementById('nextBtn').onclick = () => {
        if(pgnMoves.length===0 || stepIndex>=pgnMoves.length) return;
        const mv=game.move(pgnMoves[stepIndex],{sloppy:true});
        if(!mv) return; stepIndex++;
        board.position(game.fen()); updateFen(); refreshMoves();
      };

      document.getElementById('prevBtn').onclick = () => {
        if(stepIndex<=0) return;
        game.undo(); stepIndex--;
        board.position(game.fen()); updateFen(); refreshMoves();
      };
    }

    let currentTheme = FALLBACK_THEME;

    // MAIN INIT
    window.addEventListener('load', async () => {
      const okChess = await ensureChess();
      if(!okChess){ alert("Chess.js failed to load."); return; }

      try{ await ensureChessboard(); }
      catch(e){ alert("Chessboard.js failed to load"); return; }

      currentTheme = await chooseTheme();
      game = new Chess();
      createBoard(currentTheme);
      updateFen(); refreshMoves();
      wireUI();

      console.log("Student board ready. PGN parser loaded:", typeof parser !== "undefined");
    });
  })();
  </script>
</body>
</html>

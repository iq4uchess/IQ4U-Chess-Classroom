<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>IQ4U — Student Board (CDN fixed)</title>

  <!-- Use cdnjs (serves correct MIME types) -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/chessboard-js/1.0.0/chessboard-1.0.0.min.css" />

  <style>
    body{ font-family: Arial, sans-serif; margin:16px; background:#f4f6fb; color:#111; }
    .controls{ display:flex; justify-content:flex-end; gap:8px; margin-bottom:12px; }
    button{ padding:8px 12px; border:none; background:#0f172a; color:#fff; border-radius:8px; cursor:pointer; }
    .container{ display:grid; grid-template-columns:420px 1fr; gap:18px; align-items:start; }
    #board{ width:400px; background: #fff; border-radius:8px; padding:8px; box-shadow:0 6px 18px rgba(2,6,23,.06); }
    .panel{ background:#fff; padding:12px; border-radius:8px; box-shadow:0 6px 18px rgba(2,6,23,.04); }
    #movesList{ min-height:220px; max-height:300px; overflow:auto; padding:8px; border-radius:6px; background:#fbfdff; border:1px solid #eef2ff; }
    textarea{ width:100%; min-height:120px; padding:8px; border-radius:6px; border:1px solid #e6eefc; font-family:monospace; }
    @media (max-width:900px){ .container{ grid-template-columns: 1fr; } #board{ width:100%; } .controls{ justify-content:center; } }
  </style>
</head>
<body>

  <div class="controls">
    <button id="undoBtn">Undo</button>
    <button id="prevBtn">Previous</button>
    <button id="nextBtn">Next</button>
    <button id="flipBtn">Flip Board</button>
  </div>

  <div class="container">
    <!-- Board -->
    <div class="panel">
      <div id="board"></div>
      <div style="margin-top:10px; display:flex; justify-content:space-between; align-items:center;">
        <div>Orientation:
          <select id="orientationSelect">
            <option value="white">White</option>
            <option value="black">Black</option>
          </select>
        </div>
        <div>FEN: <code id="fenDisplay" style="font-family:monospace;"></code></div>
      </div>
    </div>

    <!-- Side controls -->
    <div style="display:flex; flex-direction:column; gap:12px;">
      <div class="panel">
        <div style="display:flex; justify-content:space-between; align-items:center;">
          <strong>PGN / FEN Input</strong>
          <button id="loadPgnBtn">Load PGN</button>
        </div>
        <div style="margin-top:8px;">
          <textarea id="pgnInput" placeholder="Paste PGN or FEN here. Example PGN: 1. e4 e5 2. Nf3 Nc6"></textarea>
          <div style="display:flex; gap:8px; margin-top:8px;">
            <button id="clearPgn">Clear</button>
            <button id="loadFenBtn">Load FEN</button>
            <button id="resetBtn">Reset</button>
          </div>
        </div>
      </div>

      <div class="panel">
        <strong>Moves</strong>
        <div id="movesList"></div>
      </div>

      <div class="panel small">
        <strong>Notes</strong>
        <ul>
          <li>Drag pieces — only legal moves allowed (Chess.js enforces legality).</li>
          <li>Load PGN then use Next/Previous to step through moves.</li>
        </ul>
      </div>
    </div>
  </div>

  <!-- JS LIBRARIES (stable cdnjs builds) -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <!-- chess.js UMD global build (no exports) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.13.0/chess.min.js"></script>
  <!-- chessboard.js UMD global build -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/chessboard-js/1.0.0/chessboard-1.0.0.min.js"></script>

  <script>
    // Basic safety check
    if (typeof Chess === 'undefined') {
      console.error('Chess.js did not load — check network / extensions.');
      alert('Chess.js failed to load. See console for details.');
    }
    if (typeof Chessboard === 'undefined') {
      console.error('Chessboard.js did not load — check network / extensions.');
      alert('Chessboard.js failed to load. See console for details.');
    }

    // Initialize
    const game = new Chess();
    let board = null;
    let pgnMoves = [];
    let stepIndex = 0;
    let orientation = 'white';

    function initBoard() {
      if (board) board.destroy();
      board = Chessboard('board', {
        draggable: true,
        position: 'start',
        orientation: orientation,
        onDrop: onDrop,
        onSnapEnd: onSnapEnd,
        pieceTheme: 'https://cdnjs.cloudflare.com/ajax/libs/chessboard-js/1.0.0/img/chesspieces/wikipedia/{piece}.png'
      });
      updateFen();
      refreshMoves();
    }

    function onDrop(source, target) {
      const move = game.move({ from: source, to: target, promotion: 'q' });
      if (move === null) return 'snapback';
      // user made new branch — clear PGN stepping
      pgnMoves = []; stepIndex = 0;
      updateFen();
      refreshMoves();
    }

    function onSnapEnd() {
      board.position(game.fen());
    }

    function updateFen(){ document.getElementById('fenDisplay').textContent = game.fen(); }

    function refreshMoves(){
      // display history or loaded PGN highlight
      const hist = game.history();
      if (pgnMoves.length > 0) {
        let html = '<div style="display:flex;flex-wrap:wrap;gap:6px">';
        for (let i=0;i<pgnMoves.length;i++){
          const cls = (i < stepIndex) ? 'style="padding:6px;border-radius:6px;background:#e6f0ff;font-weight:600;"' : 'style="padding:6px;border-radius:6px;"';
          html += `<div ${cls}>${pgnMoves[i]}</div>`;
        }
        html += '</div><hr>';
        document.getElementById('movesList').innerHTML = html;
      }
      // show the actual applied history as pairs
      let pairs = '';
      for (let i = 0; i < hist.length; i += 2) {
        const no = Math.floor(i/2) + 1;
        const w = hist[i] || '';
        const b = hist[i+1] || '';
        pairs += `<div style="padding:6px;border-radius:6px;"> <strong>${no}.</strong> ${w} ${b}</div>`;
      }
      document.getElementById('movesList').innerHTML += pairs || '<div class="small">No moves yet.</div>';
    }

    // Buttons
    document.getElementById('undoBtn').onclick = () => {
      game.undo(); board.position(game.fen()); updateFen(); refreshMoves();
    };
    document.getElementById('flipBtn').onclick = () => board.flip();
    document.getElementById('resetBtn').onclick = () => {
      game.reset(); pgnMoves = []; stepIndex = 0; board.position('start'); updateFen(); refreshMoves();
    };
    document.getElementById('clearPgn').onclick = () => document.getElementById('pgnInput').value = '';

    document.getElementById('loadFenBtn').onclick = () => {
      const txt = document.getElementById('pgnInput').value.trim();
      if (!txt) { alert('Paste a FEN into the textarea and click Load FEN'); return; }
      const ok = game.load(txt);
      if (!ok) { alert('Invalid FEN'); return; }
      pgnMoves = []; stepIndex = 0; board.position(game.fen()); updateFen(); refreshMoves();
    };

    document.getElementById('loadPgnBtn').onclick = () => {
      const pgn = document.getElementById('pgnInput').value.trim();
      if (!pgn) { alert('Paste PGN and click Load PGN'); return; }
      // parse PGN using a temp chess instance
      const tmp = new Chess();
      // older chess.js exposes load_pgn, newer exposes loadPgn — try both safely
      let ok = true;
      try {
        if (typeof tmp.load_pgn === 'function') {
          ok = tmp.load_pgn(pgn);
        } else if (typeof tmp.loadPgn === 'function') {
          ok = tmp.loadPgn(pgn);
        } else {
          ok = tmp.load(pgn);
        }
      } catch (e) { ok = false; }
      if (!ok) { alert('Could not parse PGN. Make sure PGN is valid.'); return; }
      pgnMoves = tmp.history().slice(); stepIndex = 0; game.reset(); board.position('start'); updateFen(); refreshMoves();
    };

    document.getElementById('nextBtn').onclick = () => {
      if (pgnMoves.length === 0) return;
      if (stepIndex >= pgnMoves.length) return;
      const m = game.move(pgnMoves[stepIndex], { sloppy: true });
      if (m === null) { alert('Failed to apply move: ' + pgnMoves[stepIndex]); return; }
      stepIndex++; board.position(game.fen()); updateFen(); refreshMoves();
    };

    document.getElementById('prevBtn').onclick = () => {
      if (pgnMoves.length === 0 || stepIndex <= 0) return;
      game.undo(); stepIndex--; board.position(game.fen()); updateFen(); refreshMoves();
    };

    document.getElementById('orientationSelect').onchange = function() {
      orientation = this.value;
      initBoard();
    };

    // init
    window.addEventListener('load', () => {
      initBoard();
      // make debug accessible in console
      window._iq4u = { game, board, pgnMoves };
    });
  </script>
</body>
</html>

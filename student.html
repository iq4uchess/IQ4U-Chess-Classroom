<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>IQ4U — Student Board (pieces diagnostic)</title>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/chessboard-js/1.0.0/chessboard-1.0.0.min.css" />
<style>
  body{ font-family: Arial, sans-serif; margin:12px; background:#f6f7fb; color:#111; }
  .topbar{ display:flex; justify-content:space-between; align-items:center; gap:12px; margin-bottom:12px; }
  .status{ padding:8px; border-radius:6px; background:#fff; border:1px solid #e6eefc; }
  .diag{ width:360px; max-height:520px; overflow:auto; background:#fff; border:1px solid #e6eefc; padding:8px; border-radius:8px; }
  .diag h4{ margin:6px 0; }
  .ok{ color:green; font-weight:700 }
  .bad{ color:#b91c1c; font-weight:700 }
  #board-wrapper{ width:420px; height:420px; display:flex; align-items:center; justify-content:center; }
  #board{ width:400px; height:400px; border:1px solid #e6eefc; box-sizing:border-box; background:#fff; }
  .controls{ display:flex; justify-content:flex-end; gap:8px; margin-bottom:12px; }
  button{ padding:8px 12px; border:none; background:#0f172a; color:#fff; border-radius:8px; cursor:pointer; }
  .panel{ background:#fff; padding:12px; border-radius:8px; box-shadow:0 6px 18px rgba(2,6,23,.04); }
  .small{ font-size:13px; color:#555; }
  pre.debug{ max-height:140px; overflow:auto; background:#0b1220; color:#9ae6b4; padding:8px; border-radius:6px; }
  @media (max-width:1100px){ .topbar{flex-direction:column; align-items:stretch} .diag{ width:100%; } }
</style>
</head>
<body>
  <div class="topbar">
    <div class="status" id="status">Initializing piece diagnostic...</div>
    <div class="diag" id="diag">
      <h4>Piece check (will list 12 files)</h4>
      <div id="pieceResults">Running...</div>
      <hr>
      <div class="small">If any file shows <span class="bad">404</span> — the filename or path is wrong (case-sensitive). Copy the failing URL and open it in browser to see the exact response.</div>
    </div>
  </div>

  <div class="controls">
    <button id="undoBtn">Undo</button>
    <button id="prevBtn">Previous</button>
    <button id="nextBtn">Next</button>
    <button id="flipBtn">Flip</button>
  </div>

  <div style="display:flex; gap:18px;">
    <div style="flex:0 0 460px;">
      <div class="panel">
        <div id="board-wrapper"><div id="board" aria-label="Chessboard container"></div></div>
        <div style="margin-top:10px; display:flex; justify-content:space-between; align-items:center;">
          <div>Orientation:
            <select id="orientationSelect"><option value="white">White</option><option value="black">Black</option></select>
          </div>
          <div>FEN: <code id="fenDisplay" style="font-family:monospace;"></code></div>
        </div>
      </div>
    </div>

    <div style="flex:1;">
      <div class="panel">
        <strong>PGN / FEN Input</strong>
        <textarea id="pgnInput" style="width:100%;height:160px;margin-top:8px" placeholder="Paste PGN or FEN"></textarea>
        <div style="margin-top:8px; display:flex; gap:8px;">
          <button id="loadPgnBtn">Load PGN</button>
          <button id="loadFenBtn">Load FEN</button>
          <button id="resetBtn">Reset</button>
        </div>
      </div>
      <div class="panel" style="margin-top:12px;">
        <strong>Moves</strong>
        <div id="movesList" style="min-height:220px"></div>
      </div>
    </div>
  </div>

<script>
(function(){
  // CONFIG
  const CHESS_URL = 'https://iq4uchess.github.io/IQ4U-Chess-Classroom/js/libs/chess.min.js';
  const PIECE_BASE = 'https://iq4uchess.github.io/IQ4U-Chess-Classroom/assets/pieces/cburnett/';
  const FALLBACK = 'https://cdnjs.cloudflare.com/ajax/libs/chessboard-js/1.0.0/img/chesspieces/wikipedia/{piece}.png';
  const PIECES = ['wK','wQ','wR','wB','wN','wP','bK','bQ','bR','bB','bN','bP'];

  const statusEl = document.getElementById('status');
  const pieceResults = document.getElementById('pieceResults');

  function setStatus(s){ statusEl.textContent = s; }

  // Load Chess (try module import then script)
  async function ensureChess(){
    if (typeof Chess !== 'undefined') return true;
    try{
      const mod = await import(CHESS_URL + '?t=' + Date.now());
      const candidate = mod.default || mod.Chess || mod;
      if (candidate){ window.Chess = candidate; console.log('Chess loaded via import'); return true; }
    }catch(e){ console.warn('import failed', e && e.message); }
    // script fallback
    await new Promise(r=>{
      const s = document.createElement('script'); s.src = CHESS_URL + '?t=' + Date.now(); s.onload = ()=>r(); s.onerror=()=>r(); document.head.appendChild(s);
    });
    return typeof Chess !== 'undefined';
  }

  // load chessboard library
  function loadChessboard(){
    return new Promise((res,rej)=>{
      if (typeof Chessboard !== 'undefined') return res();
      const s = document.createElement('script'); s.src = 'https://cdnjs.cloudflare.com/ajax/libs/chessboard-js/1.0.0/chessboard-1.0.0.min.js';
      s.onload = ()=>res(); s.onerror = (e)=>rej(e); document.head.appendChild(s);
    });
  }

  // check each piece URL with HEAD then GET fallback
  async function checkPieces(){
    setStatus('Checking piece files in ' + PIECE_BASE);
    pieceResults.innerHTML = 'Checking...';
    const rows = [];
    for (const p of PIECES){
      const url = PIECE_BASE + p + '.png';
      let ok=false, statusText='?';
      try{
        const head = await fetch(url, { method:'HEAD', cache:'no-store', mode:'cors' });
        statusText = head.status + ' ' + head.statusText;
        ok = head.ok;
      }catch(e){
        // try GET
        try{
          const r = await fetch(url + '?t=' + Date.now(), { method:'GET', cache:'no-store', mode:'cors' });
          statusText = r.status + ' ' + r.statusText;
          ok = r.ok && ((r.headers.get('content-type')||'').includes('image') || (r.headers.get('content-type')||'').includes('svg'));
        }catch(e2){
          statusText = 'error';
          ok=false;
        }
      }
      rows.push({piece:p, url, ok, statusText});
      // update UI incremental
      updatePieceUI(rows);
    }
    return rows;
  }

  function updatePieceUI(rows){
    let html = '<table style="width:100%">';
    html += '<tr><th style="text-align:left">Piece</th><th style="text-align:left">Status</th><th style="text-align:left">URL</th></tr>';
    for (const r of rows){
      const cls = r.ok ? 'ok' : 'bad';
      html += `<tr><td>${r.piece}</td><td class="${cls}">${r.statusText}</td><td style="font-size:12px"><a href="${r.url}" target="_blank">${r.url}</a></td></tr>`;
    }
    html += '</table>';
    pieceResults.innerHTML = html;
  }

  // choose theme based on checks
  async function detectAndStart(){
    setStatus('Loading libraries...');
    const okChess = await ensureChess();
    if (!okChess){ setStatus('Failed to load Chess.js — open console', true); return; }
    try{ await loadChessboard(); }catch(e){ setStatus('Failed to load Chessboard.js — open console', true); return; }

    // perform piece checks
    const results = await checkPieces();
    const missing = results.filter(r=>!r.ok);
    let pieceTheme;
    if (missing.length === 0){
      pieceTheme = PIECE_BASE + '{piece}.png';
      setStatus('Using custom piece set: cburnett');
    } else {
      pieceTheme = FALLBACK;
      setStatus('Custom piece set incomplete — falling back to Wikipedia pieces. See list for missing files.');
    }
    console.log('decided pieceTheme=', pieceTheme, 'missing=', missing);
    startBoard(pieceTheme);
  }

  // start the board with the chosen pieceTheme
  let game, board, pgnMoves = [], stepIndex = 0;
  function startBoard(pieceTheme){
    // create game
    game = new Chess();
    // create board with explicit sizing
    board = Chessboard('board', {
      draggable: true,
      position: 'start',
      onDrop: function(source, target){
        const move = game.move({ from: source, to: target, promotion:'q' });
        if (move === null) return 'snapback';
        pgnMoves = []; stepIndex = 0; updateFen(); refreshMoves();
      },
      onSnapEnd: function(){ board.position(game.fen()); },
      pieceTheme: pieceTheme
    });
    updateFen();
    refreshMoves();
    wireUI();
    // expose for debug
    window._iq4u = { game, board };
  }

  function updateFen(){ document.getElementById('fenDisplay').textContent = game.fen(); }
  function refreshMoves(){
    const hist = game.history();
    let html = '';
    for (let i=0;i<hist.length;i+=2){
      const no = Math.floor(i/2)+1;
      html += `<div style="padding:6px"><strong>${no}.</strong> ${hist[i]||''} ${hist[i+1]||''}</div>`;
    }
    document.getElementById('movesList').innerHTML = html || '<div class="small">No moves yet.</div>';
  }

  function wireUI(){
    document.getElementById('undoBtn').onclick = () => { game.undo(); board.position(game.fen()); updateFen(); refreshMoves(); };
    document.getElementById('flipBtn').onclick = () => board.flip();
    document.getElementById('resetBtn').onclick = () => { game.reset(); pgnMoves = []; stepIndex = 0; board.position('start'); updateFen(); refreshMoves(); };
    document.getElementById('loadFenBtn').onclick = () => {
      const txt = document.getElementById('pgnInput').value.trim();
      if (!txt){ alert('Paste FEN first'); return; }
      if (!game.load(txt)){ alert('Invalid FEN'); return; }
      pgnMoves = []; stepIndex = 0; board.position(game.fen()); updateFen(); refreshMoves();
    };
    document.getElementById('loadPgnBtn').onclick = () => {
      const pgn = document.getElementById('pgnInput').value.trim();
      if (!pgn){ alert('Paste PGN first'); return; }
      const tmp = new Chess(); let ok=true;
      try{ ok = tmp.load_pgn ? tmp.load_pgn(pgn) : tmp.loadPgn ? tmp.loadPgn(pgn) : tmp.load(pgn); } catch(e){ ok=false; }
      if (!ok){ alert('Invalid PGN'); return; }
      pgnMoves = tmp.history(); stepIndex = 0; game.reset(); board.position('start'); updateFen(); refreshMoves();
    };
    document.getElementById('nextBtn').onclick = () => {
      if (pgnMoves.length===0 || stepIndex>=pgnMoves.length) return;
      const m = game.move(pgnMoves[stepIndex], { sloppy:true });
      if (m===null){ alert('Could not apply move'); return; }
      stepIndex++; board.position(game.fen()); updateFen(); refreshMoves();
    };
    document.getElementById('prevBtn').onclick = () => {
      if (pgnMoves.length===0 || stepIndex<=0) return;
      game.undo(); stepIndex--; board.position(game.fen()); updateFen(); refreshMoves();
    };
  }

  // run
  detectAndStart();

})();
</script>
</body>
</html>

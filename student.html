<!doctype html>
<html>
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Chessboard — Puzzle Mode (Student)</title>

<!-- Local CSS / pieces -->
<link rel="stylesheet" href="lib/chessground.base.css" media="none" onload="if(this.media!='all')this.media='all'"> <!-- harmless, keeps style available -->
<style>
  /* (same inline styles from your original file) */
  html,body{height:100%;margin:0;padding:10px;font-family:Arial,Helvetica,sans-serif;box-sizing:border-box}
  *,*::before,*::after{box-sizing:inherit}
  :root{--light-square:#f0d9b5;--dark-square:#b58863;--viewport-size:512px}
  #app{display:flex;gap:18px;align-items:flex-start;flex-wrap:wrap}
  #boardColumn{display:flex;flex-direction:column;gap:12px; position:relative}
  .panel{background:#fff;padding:8px;border-radius:6px;border:1px solid #eee}
  #controls{min-width:360px;max-width:560px;position:relative}
  #boardViewport{width:var(--viewport-size);height:var(--viewport-size);border:2px solid #111;overflow:hidden;position:relative;background:#fff;touch-action:none;z-index:1}
  #boardInner{transform-origin:top left;will-change:transform,left,top;position:absolute;left:0;top:0;width:512px;height:512px;display:grid;grid-template-columns:repeat(8,64px);grid-template-rows:repeat(8,64px);z-index:1}
  .square{width:64px;height:64px;display:flex;align-items:center;justify-content:center;user-select:none;box-sizing:border-box}
  .light{background:var(--light-square)} .dark{background:var(--dark-square)}
  .last-move{box-shadow: inset 0 0 0 4px rgba(135,206,235,0.6) !important;}
  .highlight{outline:3px solid rgba(255,255,0,0.7)}
  .sq-ghost { box-shadow: inset 0 0 0 4px rgba(255,255,0,0.25); }
  .square.drag-target { outline: 3px solid rgba(255, 215, 0, 0.9); box-shadow: 0 0 0 4px rgba(135,206,235,0.25) inset; }
  .piece-img{width:46px;height:46px;display:block;object-fit:contain;pointer-events:none}
  .floating-piece{position:fixed;pointer-events:none;width:56px;height:56px;z-index:20000;will-change:left,top,transform;transition:transform 160ms cubic-bezier(.2,.9,.2,1), left 160ms cubic-bezier(.2,.9,.2,1), top 160ms cubic-bezier(.2,.9,.2,1);transform-origin:center center;touch-action:none}
  .row{display:flex;gap:8px;align-items:center}
  .btn{display:inline-block;padding:8px 12px;margin:6px 4px;background:#1976d2;color:#fff;border-radius:6px;cursor:pointer;border:none}
  .btn.secondary{background:#666}
  input[type=text], textarea{width:100%;box-sizing:border-box;padding:8px;margin-top:6px;border-radius:6px;border:1px solid #ccc}
  label{font-weight:600;display:block;margin-top:10px}
  #moves{max-height:420px;overflow:auto;background:#fafafa;padding:8px;border-radius:6px;border:1px solid #eee;margin-top:8px;font-family:monospace}
  .move-line{padding:6px 4px;border-bottom:1px solid #eee;display:flex;justify-content:space-between}
  .previewItem{width:64px;height:64px;border:1px dashed #ccc;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:4px;font-size:11px}
  #previewList{display:flex;flex-wrap:wrap;gap:8px;margin-top:8px}
  .cornerPanel{ position:absolute; left: calc(100% + 12px); top: 0; z-index:6; background:rgba(255,255,255,0.98); border-radius:6px; box-shadow:0 6px 18px rgba(0,0,0,0.12); padding:8px; border:1px solid #ddd; width:320px}
  .cornerRow{display:flex;gap:6px;align-items:center;flex-wrap:wrap}
  .small{padding:6px 8px;font-size:13px}
  .file-inline{display:flex;gap:6px;align-items:center}
  @media(max-width:1200px){
    .cornerPanel{ position:relative; left:0; top:0; width:auto; margin-top:8px; }
    #app{flex-direction:column}
  }
</style>
</head>
<body>
  <h3>Chessboard — Puzzle Mode (Student)</h3>
  <div id="app">
    <div id="boardColumn">
      <div id="boardViewport" title="Enable Crop Mode to drag the board">
        <div id="boardInner" aria-label="Chess board"></div>
      </div>

      <div class="cornerPanel" id="cornerPanel" title="Quick controls & PGN/CSV uploader">
        <div class="cornerRow" style="justify-content:flex-end">
          <button class="btn small" id="btnNew_c">New</button>
          <button class="btn small secondary" id="btnUndo_c">Undo</button>
          <button class="btn small" id="btnFlip_c">Flip</button>
          <button class="btn small" id="btnGetFen_c">Get FEN</button>
          <button class="btn small secondary" id="btnLoadFen_c">Load FEN</button>
        </div>
        <div style="margin-top:8px">
          <label style="font-weight:700;margin-bottom:6px">PGN / CSV / SAN</label>
          <div class="file-inline">
            <input id="pgnFileInput" type="file" accept=".pgn,.txt,.csv" />
            <button class="btn small" id="btnLoadPgn">Upload</button>
          </div>
          <div id="pgnHelp" style="margin-top:6px; font-size:12px; color:#444">
            Supports PGN (with optional <code>[FEN "..."]</code>), CSV (moves column), and SAN. SAN conversion uses included <code>chess.js</code> if present.
          </div>
          <div style="display:flex;gap:6px;margin-top:8px">
            <button class="btn small" id="btnNextChapter">Next Chapter</button>
            <button class="btn small secondary" id="btnResetPgn">Reset PGN</button>
            <button class="btn small" id="btnShowAnswer">Show Answer</button>
          </div>
        </div>
      </div>

      <div class="panel">
        <label><b>Viewport size</b> — <span id="vpSizeLabel">512 px</span></label>
        <input id="vpSize" type="range" min="200" max="720" value="512">
        <label style="margin-top:8px"><b>Board scale</b> — <span id="scaleLabel">100%</span></label>
        <input id="scale" type="range" min="50" max="150" value="100">
        <div style="margin-top:8px">
          <label><input id="cropMode" type="checkbox"> Crop Mode (drag board)</label>
          <button class="btn secondary" id="resetCrop" style="margin-left:8px">Reset</button>
        </div>
      </div>

      <div class="panel">
        <label><b>Piece set preview</b></label>
        <div id="previewList"></div>
      </div>
    </div>

    <div id="controls" class="panel">
      <div style="display:flex;gap:8px;flex-wrap:wrap">
        <button class="btn" id="btnExportFen">Copy FEN</button>
        <button class="btn secondary" id="btnClearArrows">Clear Arrows</button>
        <button class="btn" id="btnResetPieces">Reset Pieces</button>
      </div>

      <label>Board colours</label>
      <div class="row">
        <div style="display:flex;flex-direction:column;align-items:flex-start;">
          <span style="font-size:12px">Light square</span>
          <input id="lightColor" type="color" title="Light square color">
        </div>
        <div style="display:flex;flex-direction:column;align-items:flex-start;">
          <span style="font-size:12px">Dark square</span>
          <input id="darkColor" type="color" title="Dark square color">
        </div>
      </div>

      <label>Piece set uploader (images)</label>
      <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
        <input id="fileInput" type="file" accept="image/*,.svg" multiple>
        <button class="btn" id="applyUpload">Apply Upload</button>
        <button class="btn secondary" id="resetPieces">Reset Pieces</button>
      </div>
      <div style="font-size:12px;color:#666;margin-top:6px">Filenames → keys: <code>wP wR wN wB wQ wK bP bR bN bB bQ bK</code></div>

      <label>FEN (import/export)</label>
      <input id="fen" type="text" placeholder="FEN string">
      <div style="display:flex;gap:8px;margin-top:6px">
        <button class="btn" id="btnLoadFenField">Load FEN (field)</button>
        <button class="btn secondary" id="btnGetFenField">Copy FEN</button>
      </div>

      <label>Moves (coordinate list)</label>
      <div id="moves"></div>

      <div id="status" style="margin-top:8px;font-weight:700">Status: <span id="gameStatus">White to move</span></div>
      <div style="margin-top:8px;font-size:12px;color:#444">Shared state: <span id="sharedTs">none</span></div>
    </div>
  </div>

  <!-- Firebase (Compat) -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>

  <!-- Local chess.js (optional, used for SAN parsing) -->
  <script src="lib/chess.js"></script>

<script>
/* =========================
   Firebase configuration
   ========================= */
const firebaseConfig = {
  apiKey: "AIzaSyAIefVM1tBjWz35FRWRxmIdEJeO_vpHSKM",
  authDomain: "iq4u-chess-classroom.firebaseapp.com",
  projectId: "iq4u-chess-classroom",
  storageBucket: "iq4u-chess-classroom.appspot.com",
  messagingSenderId: "833620718306",
  appId: "1:833620718306:web:b599bb693d0736fe0da4bb",
  databaseURL: "https://iq4u-chess-classroom-default-rtdb.asia-southeast1.firebasedatabase.app/"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.database();

/* =================================
   Role/Auth checks (login required)
   - index.html must set localStorage.role = 'student1' etc.
   ================================= */
const role = localStorage.getItem('role');
if(!role || !role.startsWith('student')){
  alert('No student role found — redirecting to login.');
  window.location.href = 'index.html';
}
document.title = `IQ4U — ${role} — Puzzle`;

auth.onAuthStateChanged(user=>{
  if(!user){
    // Not signed in; redirect to login
    setTimeout(()=>{ localStorage.removeItem('role'); window.location.href='index.html'; }, 700);
  } else {
    console.log('Signed in as', user.email || user.uid);
  }
});

/* ---------- Keep the original piece SVG definitions ---------- */
const SVG_PIECES_DEFAULT = (function(){ /* same as your original SVG pieces map */ 
  const p = {};
  p.wK = `<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 45 45'><g stroke='#000' stroke-width='0.9' fill='none' stroke-linecap='round' stroke-linejoin='round'><path d='M22.5 11v6'/><path d='M20 20h5'/><path d='M9 30c6 4 30 4 33 0 0 0-3-9-3-9-10 8-24 8-32 0 0 0-3 9-3 9z'/></g></svg>`;
  p.wQ = `<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 45 45'><g stroke='#000' stroke-width='0.9' fill='none' stroke-linecap='round' stroke-linejoin='round'><circle cx='9' cy='13' r='2'/><circle cx='22.5' cy='9' r='2'/><circle cx='36' cy='13' r='2'/><path d='M9 28c6 6 30 6 36 0 0 0-3-10-3-10-12 10-24 10-30 0 0 0-3 10-3 10z'/></g></svg>`;
  p.wR = `<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 45 45'><g stroke='#000' stroke-width='0.95' fill='none'><rect x='10' y='12' width='25' height='18' rx='1'/><path d='M10 12v-4h6v4M30 12v-4h6v4' stroke-width='0.9'/></g></svg>`;
  p.wB = `<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 45 45'><g stroke='#000' stroke-width='0.95' fill='none'><path d='M22.5 11c-3 3-5 6-5 9 0 7 10 12 10 12s10-5 10-12c0-3-2-6-5-9'/><circle cx='22.5' cy='10' r='2' fill='none'/></g></svg>`;
  p.wN = `<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 45 45'><g stroke='#000' stroke-width='0.95' fill='none'><path d='M10 30c6-6 10-20 20-20 0 0 3 2 3 6 0 6-6 14-6 14'/><circle cx='18' cy='14' r='2' fill='none'/></g></svg>`;
  p.wP = `<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 45 45'><g stroke='#000' stroke-width='0.9' fill='none'><circle cx='22.5' cy='12' r='3'/><path d='M18 20c6 3 10 3 14 0 0 0-2 12-7 16-5-4-7-16-7-16z'/></g></svg>`;
  p.bK = `<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 45 45'><g stroke='#000' stroke-width='0.9' fill='#111' stroke-linecap='round' stroke-linejoin='round'><path d='M22.5 11v6'/><path d='M20 20h5'/><path d='M9 30c6 4 30 4 33 0 0 0-3-9-3-9-10 8-24 8-32 0 0 0-3 9-3 9z'/></g></svg>`;
  p.bQ = `<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 45 45'><g stroke='#000' stroke-width='0.9' fill='#111'><circle cx='9' cy='13' r='2'/><circle cx='22.5' cy='9' r='2'/><circle cx='36' cy='13' r='2'/><path d='M9 28c6 6 30 6 36 0 0 0-3-10-3-10-12 10-24 10-30 0 0 0-3 10-3 10z'/></g></svg>`;
  p.bR = `<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 45 45'><g stroke='#000' stroke-width='0.9' fill='#111'><rect x='10' y='12' width='25' height='18' rx='1'/><path d='M10 12v-4h6v4M30 12v-4h6v4' stroke-width='0.9' fill='#111'/></g></svg>`;
  p.bB = `<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 45 45'><g stroke='#000' stroke-width='0.9' fill='#111'><path d='M22.5 11c-3 3-5 6-5 9 0 7 10 12 10 12s10-5 10-12c0-3-2-6-5-9'/><circle cx='22.5' cy='10' r='2' fill='#111'/></g></svg>`;
  p.bN = `<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 45 45'><g stroke='#000' stroke-width='0.9' fill='#111'><path d='M10 30c6-6 10-20 20-20 0 0 3 2 3 6 0 6-6 14-6 14'/><circle cx='18' cy='14' r='2' fill='#111'/></g></svg>`;
  p.bP = `<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 45 45'><g stroke='#000' stroke-width='0.9' fill='#111'><circle cx='22.5' cy='12' r='3'/><path d='M18 20c6 3 10 3 14 0 0 0-2 12-7 16-5-4-7-16-7-16z' fill='#111'/></g></svg>`;
  const map={}; for(const k in p) map[k] = 'data:image/svg+xml;utf8,' + encodeURIComponent(p[k]); return map;
})();

/* ---------- piece storage helpers ---------- */
function loadPiecesFromLocal(){ try{ const raw=localStorage.getItem('customPieceSet'); if(!raw) return null; return JSON.parse(raw);}catch(e){return null;} }
function savePiecesToLocal(pieces){ try{ localStorage.setItem('customPieceSet', JSON.stringify(pieces)); }catch(e){} }
function resetPiecesToDefault(){ PIECES = Object.assign({}, SVG_PIECES_DEFAULT); savePiecesToLocal(PIECES); renderBoard(); buildPreview(); }

/* ---------- initial PIECES (can be overridden by uploads) ---------- */
let PIECES = loadPiecesFromLocal() || Object.assign({}, SVG_PIECES_DEFAULT);
const KEYS = ['wP','wR','wN','wB','wQ','wK','bP','bR','bN','bB','bQ','bK'];

/* ---------- state & DOM ---------- */
let boardState=[], whiteToMove=true, moveHistory=[], lastMove=null, flipped=false;
let castlingRights = { wK:true, wQ:true, bK:true, bQ:true };
let enPassantSquare = null;
const boardEl = document.getElementById('boardInner');
const movesEl = document.getElementById('moves');
const statusEl = document.getElementById('gameStatus');
const sharedTsEl = document.getElementById('sharedTs');
let lastServerTs = 0;

/* ---------- helper funcs (coord conversion, find el) ---------- */
function makeEmptyBoard(){ const b=[]; for(let r=0;r<8;r++) b[r]=new Array(8).fill(null); return b; }
function rcToCoord(r,c){ return String.fromCharCode(97+c) + (8-r); }
function coordToRC(coord){ if(!coord||coord.length<2) return null; const c=coord.charCodeAt(0)-97; const r=8-parseInt(coord[1]); if(r<0||r>7||c<0||c>7) return null; return {r,c}; }
function findSquareEl(coord){ return boardEl.querySelector('[data-coord="'+coord+'"]'); }

/* ---------- colours ---------- */
function loadSavedColours(){ const light = localStorage.getItem('chess_light') || '#f0d9b5'; const dark  = localStorage.getItem('chess_dark')  || '#b58863'; document.documentElement.style.setProperty('--light-square', light); document.documentElement.style.setProperty('--dark-square', dark); const lc = document.getElementById('lightColor'), dc = document.getElementById('darkColor'); if(lc) lc.value = light; if(dc) dc.value = dark; }
function saveColours(light,dark){ localStorage.setItem('chess_light', light); localStorage.setItem('chess_dark', dark); document.documentElement.style.setProperty('--light-square', light); document.documentElement.style.setProperty('--dark-square', dark); }
const lcEl = document.getElementById('lightColor'); const dcEl = document.getElementById('darkColor');
if(lcEl && dcEl){ lcEl.addEventListener('input', (e)=>{ saveColours(e.target.value, dcEl.value); }); dcEl.addEventListener('input', (e)=>{ saveColours(lcEl.value, e.target.value); }); }
loadSavedColours();

/* ---------- render ---------- */
function renderBoard(){
  boardEl.innerHTML = '';
  const rows = flipped? [...Array(8).keys()].reverse() : [...Array(8).keys()];
  const cols = flipped? [...Array(8).keys()].reverse() : [...Array(8).keys()];
  for(const r of rows){
    for(const c of cols){
      const sq = document.createElement('div');
      sq.className = 'square ' + (((r+c)%2===0)?'light':'dark');
      const coord = rcToCoord(r,c);
      sq.dataset.coord = coord;
      sq.dataset.r = r; sq.dataset.c = c;
      const p = boardState[r][c];
      if(p){
        const img = document.createElement('img');
        img.src = PIECES[p] || SVG_PIECES_DEFAULT[p];
        img.className = 'piece-img';
        img.draggable = false;
        sq.appendChild(img);
      }
      boardEl.appendChild(sq);
    }
  }
  applyLastMoveHighlight(lastMove);
  attachPointerHandlersToSquares();
}

/* ---------- piece preview ---------- */
function buildPreview(){ const previewList = document.getElementById('previewList'); previewList.innerHTML = ''; for(const k of KEYS){ const div = document.createElement('div'); div.className='previewItem'; const img = document.createElement('img'); img.style.maxWidth='60px'; img.style.maxHeight='60px'; img.src = PIECES[k] || SVG_PIECES_DEFAULT[k]; const lbl = document.createElement('div'); lbl.style.fontSize='11px'; lbl.textContent=k; div.appendChild(img); div.appendChild(lbl); previewList.appendChild(div); } }

/* ---------- legality & helpers (kept from original) ---------- */
/* (isPathClear, isLegalMove, castling attack checks, etc.)
   ... put original definitions here exactly as in your file ...
   For brevity in this response I assume same helper functions are present.
*/

/* --------- NOTE: The rest of the original logic — move execution,
   animation, moves UI, PGN parsing, chapter loading, arrows, crop,
   pointer handlers, uploads, piece application, UNZIP server handling
   removed/modified to client-only — remains the same as original file,
   except where google.script.run was used.  We'll replace server calls
   with Firebase below. ---------- */

/* ---------- REPLACING server calls with Firebase ---------- */

/* pushStateToServer -> writes to db at classroom/students/<role> */
function pushStateToServer(){
  try{
    const data = {
      fen: getFEN(),
      moves: JSON.stringify(moveHistory||[]),
      ts: Date.now()
    };
    db.ref(`classroom/students/${role}`).update(data)
      .then(()=> {
        lastServerTs = data.ts;
        sharedTsEl.textContent = new Date(data.ts).toLocaleTimeString();
      })
      .catch(err => console.warn('Failed writing state to DB', err));
  }catch(e){ console.warn('pushStateToServer err', e); }
}

/* Instead of polling, attach a real-time listener for student node */
function attachRealtimeListeners(){
  const nodeRef = db.ref(`classroom/students/${role}`);
  nodeRef.on('value', snap=>{
    const val = snap.val();
    if(!val) return;
    // ignore updates that are older or equal to our lastServerTs
    if(val.ts && Number(val.ts) <= lastServerTs) {
      // but still allow pgn/control changes even if ts same
    } else if(val.ts){
      lastServerTs = Number(val.ts);
      sharedTsEl.textContent = new Date(lastServerTs).toLocaleTimeString();
    }
    // apply fen if present (and not originating locally)
    if(val.fen){
      const currentFen = getFEN();
      if(val.fen !== currentFen){
        // if we recently wrote (isLocalMove flag), ignore one cycle handled elsewhere
        try{ loadFEN(val.fen); }catch(e){ console.warn('Failed to load fen from db', e); }
      }
    }
    // apply moves (if present)
    if(val.moves){
      try{ moveHistory = JSON.parse(val.moves || '[]'); updateMovesUI(); }catch(e){}
    }
    // apply pgn (master might have set)
    if(val.pgn){
      // if pgn differs from current chapter pgn, load it
      if(!chapters.length || chapters._lastLoadedPgn !== val.pgn){
        chapters = []; currentChapter = -1;
        // parse pgn string into chapters and auto-load first
        parsePGNtextToChapters(val.pgn).then(parsed=>{
          chapters = parsed;
          chapters._lastLoadedPgn = val.pgn;
          if(chapters.length>0){ currentChapter = 0; loadChapter(currentChapter); }
        }).catch(err=>console.warn('pgn parse failed', err));
      }
    }
    // apply control flags
    if(val.control){
      const c = val.control;
      if(c.locked){
        // Prevent moves by setting flag — we disable pointer handlers below
        disableMoveInput = true;
      } else {
        disableMoveInput = false;
      }
    }
  });
}

/* ---------- Override PGN ZIP server parts ----------
   - The previous code used google.script.run.unzipPieces(server-side). Removed.
   - We implement client-side image uploads only. ZIP uploads will alert (server needed).
*/
async function handleZipFileServer(file){
  alert('ZIP uploads require a server to unzip. Please upload individual image files instead. (Server unzip not implemented in this build.)');
  return [];
}

/* ---------- Initialization: start & attach listeners ---------- */
function init(){
  // original init logic (setupStartPosition etc.)
  setupStartPosition();
  applyViewportSize(Number(document.getElementById('vpSize').value));
  applyBoardScale(Number(document.getElementById('scale').value));
  buildPreview();
  // replaced polling with realtime DB listeners
  attachRealtimeListeners();
}
init();

</script>
</body>
</html>

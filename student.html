<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>IQ4U Chess Classroom — Student (Chessground, local libs)</title>

  <!-- Local Chessground CSS -->
  <link rel="stylesheet" href="lib/chessground.base.css">

  <style>
    :root {
      --card-bg: #ffffff;
      --accent: #1976d2;
      --muted: #666;
    }
    body {
      margin: 0;
      font-family: Inter, Arial, sans-serif;
      background: #f3f6fb;
      display: flex;
      flex-direction: column;
      min-height: 100vh;
      align-items: center;
      padding: 18px;
    }

    header {
      width: 100%;
      max-width: 960px;
      display:flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }

    .brand { display:flex; flex-direction: column; }
    .brand h1 { margin:0; font-size:18px; color:#111; }
    .brand small { color:var(--muted); }

    .controls { display:flex; gap:8px; align-items:center; }

    button {
      background: var(--accent);
      color: white;
      border: none;
      padding: 8px 12px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
    }
    button.secondary {
      background: white;
      color: var(--accent);
      border: 1px solid rgba(25,118,210,.15);
    }
    button.ghost {
      background: transparent;
      color: var(--muted);
      border: none;
    }

    main {
      width: 100%;
      max-width: 960px;
      display: flex;
      gap: 20px;
      align-items: flex-start;
    }

    .left {
      background: var(--card-bg);
      border-radius: 10px;
      padding: 16px;
      box-shadow: 0 6px 18px rgba(20,40,80,0.06);
      flex: 0 0 420px;
      display:flex;
      flex-direction: column;
      align-items: center;
    }

    #board {
      width: 400px;
      height: 400px;
    }

    .status { margin-top: 10px; width: 100%; text-align: center; color: var(--muted); font-size: 14px; }

    .right {
      flex: 1;
      min-height: 200px;
      background: var(--card-bg);
      border-radius: 10px;
      padding: 12px;
      box-shadow: 0 6px 18px rgba(20,40,80,0.06);
    }

    .panel-row { display:flex; gap:8px; margin-bottom:10px; }
    .panel-row > div { flex:1; }

    label.small { font-size:12px; color:var(--muted); display:block; margin-bottom:4px; }

    pre#log {
      background: #081427;
      color: #d6f3ff;
      padding: 10px;
      border-radius: 6px;
      height: 200px;
      overflow:auto;
      margin:0;
      font-size:13px;
    }

    @media (max-width: 860px) {
      main { flex-direction: column; align-items:center; }
      .left { width: 100%; max-width: 420px; }
      .right { width: 100%; max-width: 420px; }
      #board { width: 320px; height: 320px; }
    }
  </style>
</head>
<body>
  <header>
    <div class="brand">
      <h1>IQ4U — Student Board (Chessground)</h1>
      <small id="studentIdLabel">Loading...</small>
    </div>

    <div class="controls">
      <button id="flipBtn" class="secondary">Flip Board</button>
      <button id="undoBtn" class="secondary">Undo</button>
      <button id="logoutBtn" class="ghost">Logout</button>
    </div>
  </header>

  <main>
    <section class="left">
      <div id="board"></div>
      <div class="status" id="status">Connecting to Firebase...</div>
    </section>

    <aside class="right">
      <div class="panel-row">
        <div>
          <label class="small">Current FEN</label>
          <input id="fenInput" style="width:100%;padding:8px;border-radius:6px;border:1px solid #ddd" />
        </div>
      </div>

      <div class="panel-row">
        <div>
          <label class="small">Latest PGN from Master (if any)</label>
          <textarea id="pgnBox" style="width:100%;height:100px;border-radius:6px;border:1px solid #ddd;padding:8px" readonly></textarea>
        </div>
      </div>

      <div style="margin-top:8px">
        <label class="small">Logs</label>
        <pre id="log">Logs will appear here...</pre>
      </div>
    </aside>
  </main>

  <!-- Firebase compat SDKs (CDN - recommended). If you need them local I can provide download commands. -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>

  <!-- Local libs (your files) -->
  <script src="lib/chess.js"></script>
  <script src="lib/chessground.min.js"></script>

  <script>
    /****************************************************
     * Student page (Chessground, local libs)
     * This version matches these files:
     *  - /lib/chess.js
     *  - /lib/chessground.min.js
     *  - /lib/chessground.base.css
     *
     * Defensive initialization for Chessground and chess.js
     ****************************************************/

    // ---------- CONFIG ----------
    const firebaseConfig = {
      apiKey: "AIzaSyAIefVM1tBjWz35FRWRxmIdEJeO_vpHSKM",
      authDomain: "iq4u-chess-classroom.firebaseapp.com",
      projectId: "iq4u-chess-classroom",
      storageBucket: "iq4u-chess-classroom.appspot.com",
      messagingSenderId: "833620718306",
      appId: "1:833620718306:web:b599bb693d0736fe0da4bb",
      databaseURL: "https://iq4u-chess-classroom-default-rtdb.asia-southeast1.firebasedatabase.app/"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.database();

    // ---------- STATE ----------
    const role = localStorage.getItem("role");
    const studentLabel = document.getElementById("studentIdLabel");
    const statusEl = document.getElementById("status");
    const fenInput = document.getElementById("fenInput");
    const pgnBox = document.getElementById("pgnBox");
    const logEl = document.getElementById("log");

    if (!role || !role.startsWith("student")) {
      window.location.href = "index.html";
    }
    studentLabel.textContent = `You are: ${role}`;

    function appendLog(msg) {
      const t = new Date().toLocaleTimeString();
      logEl.textContent = `[${t}] ${msg}\n` + logEl.textContent;
    }

    // ---------- chess.js (ensure global Chess exists) ----------
    let ChessCtor = null;
    if (typeof Chess !== 'undefined') {
      ChessCtor = Chess;             // some builds expose `Chess`
    } else if (typeof window.Chess !== 'undefined') {
      ChessCtor = window.Chess;
    } else if (typeof window.ChessJS !== 'undefined') {
      ChessCtor = window.ChessJS;
    } else {
      appendLog('ERROR: chess.js not found. Ensure lib/chess.js defines global Chess.');
      throw new Error('chess.js global not found');
    }

    const game = new ChessCtor(); // chess.js instance for legality, pgn, fen

    // ---------- Chessground init (defensive) ----------
    const cgElement = document.getElementById('board');
    let cg = null;

    // config common to builds
    const cfg = {
      fen: game.fen(),
      orientation: 'white',
      movable: {
        free: false,
        // color undefined so both colors can move; chess.js enforces legal moves
        color: undefined
      },
      highlight: true,
      animations: { duration: 200 },
      events: {
        // many chessground builds call events.move(from, to)
        move: (from, to) => {
          handleUserMove(from, to);
        }
      }
    };

    // Helper to attempt multiple init styles
    function createChessground() {
      appendLog('Trying to init Chessground — available globals: ' + Object.keys(window).filter(k => k.toLowerCase().includes('chess')).join(', '));
      try {
        // Common factory style: Chessground(element, config)
        if (typeof Chessground === 'function') {
          return Chessground(cgElement, cfg);
        }

        // Namespaced/class style: new Chessground.Chessground(element, config)
        if (window.Chessground && typeof window.Chessground.Chessground === 'function') {
          return new window.Chessground.Chessground(cgElement, cfg);
        }

        // Some builds expose Chessground.default or .mount
        if (window.Chessground && typeof window.Chessground === 'object' && typeof window.Chessground.mount === 'function') {
          window.Chessground.mount(cgElement, cfg);
          // mount may not return instance; try to read a global reference
          return window.chessgroundInstance || null;
        }

        throw new Error('No compatible Chessground export found.');
      } catch (err) {
        appendLog('Chessground init error: ' + err.message);
        console.error(err);
        throw err;
      }
    }

    cg = createChessground();
    if (!cg) {
      appendLog('Chessground instance not returned. Some builds do not return instance on mount; attempting to proceed with a minimal API.');
    } else {
      appendLog('Chessground initialized.');
    }

    // ---------- helpers ----------
    let isLocalMove = false;

    function handleUserMove(from, to) {
      // Validate with chess.js
      const mv = game.move({ from, to, promotion: 'q' });
      if (!mv) {
        // illegal — reset board to legal position
        try {
          if (cg && typeof cg.set === 'function') cg.set({ fen: game.fen() });
        } catch (e) {}
        appendLog(`Illegal move attempted: ${from} → ${to}`);
        return;
      }
      const newFen = game.fen();
      isLocalMove = true;
      db.ref(`classroom/students/${role}/fen`).set(newFen)
        .then(() => appendLog(`Moved ${mv.san} — saved FEN.`))
        .catch(err => appendLog('DB write error: ' + err.message));
    }

    function setFenOnClient(fen) {
      const ok = game.load(fen);
      // Some builds return true/false; if invalid, chess.js may throw
      try {
        if (!ok && typeof ok !== 'undefined') {
          appendLog('Warning: game.load returned false for the FEN.');
        }
      } catch(e){}
      // update Chessground
      try {
        if (cg && typeof cg.set === 'function') cg.set({ fen: game.fen() });
        else {
          // some mounted builds require a different API — attempt to set the element's inner state
          appendLog('Warning: cg.set not available; visual may not update. Inspect your Chessground build API.');
        }
      } catch (err) {
        console.warn(err);
      }
      fenInput.value = game.fen();
      updateStatus();
    }

    // ---------- DB refs ----------
    const fenRef = db.ref(`classroom/students/${role}/fen`);
    const pgnRef = db.ref(`classroom/students/${role}/pgn`);
    const controlRef = db.ref(`classroom/students/${role}/control`);

    // Listen for remote FEN updates
    fenRef.on('value', snap => {
      const fen = snap.val();
      if (!fen) return;
      if (isLocalMove) {
        isLocalMove = false;
        appendLog('Ignored FEN update (local origin).');
        return;
      }
      try {
        setFenOnClient(fen);
        appendLog('FEN updated from server.');
      } catch (err) {
        appendLog('Failed to load FEN from server: ' + err.message);
      }
    });

    // Ensure initial FEN exists
    fenRef.once('value').then(snap => {
      if (!snap.exists()) {
        fenRef.set(game.fen());
        appendLog('Initialized FEN on server (startpos).');
      } else {
        const fen = snap.val();
        if (fen) {
          setFenOnClient(fen);
          appendLog('Loaded existing FEN from server.');
        }
      }
    }).catch(err => appendLog('Initial FEN read error: ' + err.message));

    // Listen for PGN from master
    pgnRef.on('value', snap => {
      const pgn = snap.val();
      if (!pgn) return;
      pgnBox.value = pgn;
      try {
        // Defensive PGN loader for chess.js variants
        if (typeof game.load_pgn === 'function') { game.reset(); game.load_pgn(pgn); }
        else if (typeof game.loadPgn === 'function') { game.reset(); game.loadPgn(pgn); }
        else if (typeof game.load === 'function') {
          // fallback: try to parse moves manually (not implemented)
          appendLog('No PGN loader available on this chess.js build.');
        }
        // write resulting FEN back
        const newFen = game.fen();
        isLocalMove = true;
        fenRef.set(newFen).then(() => {
          setFenOnClient(newFen);
          appendLog('Loaded PGN from master and updated FEN.');
        }).catch(err => appendLog('Failed saving FEN after PGN: ' + err.message));
      } catch (err) {
        appendLog('Error loading PGN: ' + err.message);
      }
    });

    // Control (lock/unlock)
    controlRef.on('value', snap => {
      const ctrl = snap.val();
      if (!ctrl) return;
      if (ctrl.locked) {
        try {
          if (cg && typeof cg.set === 'function') cg.set({ movable: { color: null, free: false } });
        } catch (err) {}
        appendLog('Master locked moves.');
      } else {
        try {
          if (cg && typeof cg.set === 'function') cg.set({ movable: { color: undefined, free: false } });
        } catch (err) {}
        appendLog('Master unlocked moves.');
      }
    });

    // Manual FEN
    fenInput.addEventListener('change', () => {
      const f = fenInput.value.trim();
      if (!f) return;
      try {
        game.load(f);
        const newFen = game.fen();
        isLocalMove = true;
        fenRef.set(newFen).then(() => {
          setFenOnClient(newFen);
          appendLog('Manual FEN applied and saved.');
        });
      } catch (err) {
        appendLog('Invalid FEN: ' + err.message);
      }
    });

    // Flip
    document.getElementById('flipBtn').addEventListener('click', () => {
      try {
        // many builds use cg.state.orientation or cg.state().orientation
        const current = (cg && cg.state && cg.state.orientation) || (cg && cg.state && cg.state().orientation) || 'white';
        const next = current === 'white' ? 'black' : 'white';
        if (cg && typeof cg.set === 'function') cg.set({ orientation: next });
        else appendLog('Flip not supported by this Chessground build.');
      } catch (err) {
        appendLog('Flip error: ' + err.message);
      }
    });

    // Undo
    document.getElementById('undoBtn').addEventListener('click', () => {
      const mv = game.undo();
      if (!mv) {
        appendLog('No move to undo.');
        return;
      }
      const newFen = game.fen();
      isLocalMove = true;
      fenRef.set(newFen).then(() => {
        setFenOnClient(newFen);
        appendLog('Undo performed and saved.');
      }).catch(err => appendLog('Undo save error: ' + err.message));
    });

    // Logout
    document.getElementById('logoutBtn').addEventListener('click', () => {
      auth.signOut().catch(()=>{});
      localStorage.removeItem('role');
      window.location.href = 'index.html';
    });

    // Status updater
    function updateStatus() {
      let s = '';
      if (game.in_checkmate && game.in_checkmate()) s = 'Checkmate';
      else if (game.in_draw && game.in_draw()) s = 'Draw';
      else if (game.in_check && game.in_check()) s = 'Check';
      else s = (game.turn && game.turn() === 'w') ? 'White to move' : 'Black to move';
      statusEl.textContent = s;
    }
    setInterval(updateStatus, 500);

    // Auth protection
    auth.onAuthStateChanged(user => {
      if (!user) {
        appendLog('Not authenticated — redirecting to login.');
        localStorage.removeItem('role');
        setTimeout(()=>window.location.href='index.html', 700);
      } else {
        appendLog(`Signed in as ${user.email || user.uid}`);
      }
    });

  </script>
</body>
</html>

<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>IQ4U — Student Board</title>

  <!-- CDN CSS -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/chessboard-js/1.0.0/chessboard-1.0.0.min.css" integrity="sha512-YOUR_INTEGRITY_HASH_IF_REQUIRED" crossorigin="anonymous" referrerpolicy="no-referrer" />
  <style>
    body{ font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; margin:0; padding:16px; background:#f6f7fb; color:#111; }
    .container{ max-width:1200px; margin:0 auto; display:grid; grid-template-columns: 420px 1fr; gap:18px; align-items:start; }
    .controls-strip{ display:flex; justify-content:flex-end; gap:8px; margin-bottom:8px; }
    button{ background:#1f2937; color:#fff; border:0; padding:8px 12px; border-radius:8px; cursor:pointer; font-weight:600; }
    button:active{ transform:translateY(1px); }
    .board-wrap{ background:#fff; padding:12px; border-radius:12px; box-shadow:0 6px 18px rgba(17,24,39,0.06); }
    .panel{ background:#fff; padding:12px; border-radius:12px; box-shadow:0 6px 18px rgba(17,24,39,0.04); }
    #board{ width:400px; }
    .small{ font-size:13px; color:#555; }
    #movesList{ height:220px; overflow:auto; padding:8px; border-radius:8px; background:#fbfdff; border:1px solid #eef2ff; }
    textarea { width:100%; min-height:120px; resize:vertical; padding:8px; border-radius:8px; border:1px solid #e6eefc; font-family:monospace; }
    .meta { margin-top:8px; display:flex; justify-content:space-between; gap:12px; align-items:center; }
    .meta .fenv { font-family:monospace; font-size:13px; color:#333; background:#f3f4f6; padding:6px 8px; border-radius:6px; }
    @media (max-width:900px){
      .container{ grid-template-columns: 1fr; }
      #board{ width:100%; max-width:420px; margin: 0 auto; }
      .controls-strip{ justify-content:center; margin-bottom:12px; }
    }
  </style>
</head>
<body>

  <div class="controls-strip">
    <button id="undoBtn">Undo</button>
    <button id="prevBtn">Previous</button>
    <button id="nextBtn">Next</button>
    <button id="flipBtn">Flip Board</button>
  </div>

  <div class="container">
    <!-- Left: Board -->
    <div class="board-wrap">
      <div id="board" style="margin:0 auto;"></div>
      <div class="meta" style="margin-top:12px;">
        <div class="small">Orientation:
          <select id="orientationSelect">
            <option value="white">White</option>
            <option value="black">Black</option>
          </select>
        </div>
        <div class="small">FEN: <span id="fenDisplay" class="fenv">start</span></div>
      </div>
    </div>

    <!-- Right: Controls & PGN -->
    <div style="display:flex; flex-direction:column; gap:12px;">
      <div class="panel">
        <div style="display:flex; justify-content:space-between; align-items:center;">
          <strong>PGN / FEN Input</strong>
          <button id="loadPgnBtn">Load PGN</button>
        </div>
        <div style="margin-top:8px;">
          <textarea id="pgnInput" placeholder="Paste PGN (or FEN) here. Example PGN: 1. e4 e5 2. Nf3 Nc6"></textarea>
          <div style="display:flex; gap:6px; margin-top:8px;">
            <button id="clearPgn">Clear</button>
            <button id="loadFenBtn">Load FEN</button>
            <button id="resetBtn">Reset Board</button>
          </div>
        </div>
      </div>

      <div class="panel">
        <strong>Moves</strong>
        <div id="movesList" class="small"></div>
      </div>

      <div class="panel small">
        <div><strong>Usage Notes</strong></div>
        <ul>
          <li>Drag pieces to play — only legal moves allowed.</li>
          <li>Use <em>Load PGN</em> to load an entire study and then use Next/Previous to step through moves.</li>
          <li><em>Load FEN</em> allows loading a single position (enter FEN in the textarea).</li>
        </ul>
      </div>
    </div>
  </div>

  <!-- CDN JS -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js" integrity="sha512-..." crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.13.1/chess.min.js" integrity="sha512-..." crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/chessboard-js/1.0.0/chessboard-1.0.0.min.js" integrity="sha512-..." crossorigin="anonymous" referrerpolicy="no-referrer"></script>

  <script>
    // Ensure global objects exist
    if (typeof Chess === 'undefined') {
      alert('Chess.js did not load. Check CDN links.');
    }
    if (typeof Chessboard === 'undefined') {
      alert('Chessboard.js did not load. Check CDN links.');
    }

    // Game state for interactive play
    const game = new Chess();          // chess.js game for validation
    let board = null;                  // chessboard UI instance
    let orientation = 'white';

    // PGN stepping state
    let pgnMoves = [];      // SAN moves array from loaded PGN
    let stepIndex = 0;      // how many half-moves have been applied to the board (0 = starting pos)

    // Initialize the UI board
    function initBoard() {
      const config = {
        draggable: true,
        position: 'start',
        orientation: orientation,
        onDrop: onDrop,
        onSnapEnd: onSnapEnd,
        pieceTheme: 'https://cdnjs.cloudflare.com/ajax/libs/chessboard-js/1.0.0/img/chesspieces/wikipedia/{piece}.png'
      };
      board = Chessboard('board', config);
      updateFenDisplay();
      refreshMovesList();
    }

    // Called when a drag ends (when piece is dropped)
    function onDrop(source, target, piece, newPos, oldPos, orientationBoard) {
      // Try to make the move on the game
      const move = game.move({ from: source, to: target, promotion: 'q' }); // always promote to queen if needed
      if (move === null) {
        // Illegal move
        return 'snapback';
      } else {
        // Played a legal move: update displays; clear PGN stepping state (since user made a new branch)
        pgnMoves = []; stepIndex = 0;
        updateFenDisplay();
        refreshMovesList();
      }
    }

    // Ensure board shows the current game position after snap (move animation)
    function onSnapEnd() {
      board.position(game.fen());
    }

    // Buttons behavior
    $('#undoBtn').on('click', () => {
      const undone = game.undo();
      if (undone) {
        board.position(game.fen());
        updateFenDisplay();
        refreshMovesList();
      }
    });

    $('#flipBtn').on('click', () => {
      board.flip();
    });

    $('#orientationSelect').on('change', function() {
      orientation = $(this).val();
      board.destroy();
      initBoard();
    });

    // Reset board to start
    $('#resetBtn').on('click', () => {
      game.reset();
      pgnMoves = []; stepIndex = 0;
      board.position('start');
      updateFenDisplay();
      refreshMovesList();
    });

    // Clear PGN textarea
    $('#clearPgn').on('click', () => { $('#pgnInput').val(''); });

    // Load FEN (single position)
    $('#loadFenBtn').on('click', () => {
      const txt = $('#pgnInput').val().trim();
      if (!txt) { alert('Paste FEN in the textarea and click Load FEN'); return; }
      const ok = game.load(txt);
      if (!ok) {
        alert('Invalid FEN');
        return;
      }
      pgnMoves = []; stepIndex = 0;
      board.position(game.fen());
      updateFenDisplay();
      refreshMovesList();
    });

    // Load PGN
    $('#loadPgnBtn').on('click', () => {
      const pgn = $('#pgnInput').val().trim();
      if (!pgn) { alert('Paste a PGN into the textarea and click Load PGN'); return; }

      // Create a fresh chess object to parse PGN safely
      const tmp = new Chess();
      const ok = tmp.load_pgn ? tmp.load_pgn(pgn) : tmp.loadPgn ? tmp.loadPgn(pgn) : null;
      // chess.js versions have load_pgn or loadPgn; handle both
      if (ok === false) {
        // load_pgn returns false on failure for older versions
        alert('Could not parse PGN. Make sure PGN is valid.');
        return;
      }

      // If tmp.history exists, get SAN list
      const hist = tmp.history();
      // Reset main game to starting position
      game.reset();
      pgnMoves = hist.slice(); // copy moves
      stepIndex = 0;
      board.position(game.fen());
      updateFenDisplay();
      refreshMovesList();
      // If there are any moves, automatically step to move 1 (optional). We'll leave at start and let user step.
    });

    // Next / Previous stepping for loaded PGN
    $('#nextBtn').on('click', () => {
      if (pgnMoves.length === 0) return;
      if (stepIndex >= pgnMoves.length) return;
      const moveSan = pgnMoves[stepIndex];
      const m = game.move(moveSan, {sloppy: true}); // allow SAN parsing
      if (m === null) {
        // fallback: try algebraic forms
        const alternative = pgnMoves[stepIndex];
        // If fail, stop
        alert('Failed to apply move: ' + alternative);
        return;
      }
      stepIndex++;
      board.position(game.fen());
      updateFenDisplay();
      refreshMovesList();
    });

    $('#prevBtn').on('click', () => {
      if (pgnMoves.length === 0) return;
      if (stepIndex <= 0) return;
      game.undo();
      stepIndex--;
      board.position(game.fen());
      updateFenDisplay();
      refreshMovesList();
    });

    // Update FEN shown
    function updateFenDisplay() {
      $('#fenDisplay').text(game.fen());
    }

    // Refresh move list panel (shows history and current step marker for PGN stepping)
    function refreshMovesList() {
      const hist = game.history();
      const movesHtml = [];
      // Format as pairs: 1. e4 e5 2. Nf3 ...
      for (let i = 0; i < hist.length; i += 2) {
        const moveNo = (i/2) + 1;
        const w = hist[i] ? hist[i] : '';
        const b = hist[i+1] ? hist[i+1] : '';
        movesHtml.push(`<div style="padding:4px 6px; border-radius:6px; ${i+1 <= (stepIndex*1) ? 'background:#eef2ff' : ''}"><strong>${moveNo}.</strong> ${w} ${b}</div>`);
      }

      // If PGN loaded but user hasn't progressed, also show full PGN moves with highlight by stepIndex
      if (pgnMoves.length > 0) {
        // Show full PGN move list with highlight at current step
        let html = '<div style="display:flex;flex-wrap:wrap;gap:6px">';
        for (let i = 0; i < pgnMoves.length; i++) {
          const cls = (i < stepIndex) ? 'style="padding:4px 6px;background:#e6f0ff;border-radius:6px;font-weight:600;"' : 'style="padding:4px 6px;border-radius:6px;"';
          html += `<div ${cls}>${pgnMoves[i]}</div>`;
        }
        html += '</div><hr style="margin:8px 0">';
        $('#movesList').html(html + (movesHtml.join('') || '<div class="small">No moves yet.</div>'));
      } else {
        $('#movesList').html(movesHtml.join('') || '<div class="small">No moves yet.</div>');
      }
    }

    // Init everything
    $(function(){
      initBoard();
      // Expose debugging globally for quick console checks
      window._iq4u = { board, game, pgnMoves };
    });
  </script>

</body>
</html>

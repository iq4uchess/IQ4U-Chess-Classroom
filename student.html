<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>IQ4U — Student Puzzle (centered top board + resizer) - MULTIPLAYER ENHANCED</title>

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/chessboard-js/1.0.0/chessboard-1.0.0.min.css" />
  <style>
    html,body{ overscroll-behavior-y: contain; height:100%; }
    body{ font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, Arial; margin:16px; background:#f6f7fb; color:#111; -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale; display:flex; flex-direction:column; align-items:center; }
    button{ padding:8px 12px; border:none; background:#0f172a; color:#fff; border-radius:8px; cursor:pointer; }
    .container{ display:grid; grid-template-columns:420px 1fr; gap:18px; align-items:start; width:100%; justify-content:center; }
    .panel{ background:#fff; padding:12px; border-radius:10px; box-shadow:0 6px 18px rgba(2,6,23,.04); margin:0 auto; max-width:920px; width:100%; box-sizing:border-box; }
    .small{ font-size:13px; color:#555; }
    .muted{ color:#666; font-size:13px; }
    .info{ margin-top:8px; font-size:13px; color:#444; text-align:center; }
    .board-top{ grid-column: 1 / -1; display:flex; flex-direction:column; align-items:center; gap:12px; width:100%; }
    .controls{ display:flex; gap:8px; justify-content:center; align-items:center; width:100%; }
    /* default board wrapper now 570px */
    #board-wrapper{ width:100%; max-width:570px; display:flex; align-items:center; justify-content:center; transition: max-width 180ms ease; margin:0 auto; }
    #board-wrapper, #board { touch-action: none; -webkit-user-select: none; -webkit-touch-callout: none; user-select: none; -ms-touch-action: none; }
    #board{ width:100%; aspect-ratio: 1 / 1; border:1px solid #e6eefc; box-sizing:border-box; background:#fff; max-height:80vh; }
    .resizer{ display:flex; gap:10px; align-items:center; background:transparent; justify-content:center; width:100%; }
    .resizer .range{ width:260px; }
    .resizer small{ color:#444; display:block; min-width:48px; text-align:center; font-size:13px; }
    #movesList{ min-height:220px; max-height:300px; overflow:auto; padding:8px; border-radius:6px; background:#fbfdff; border:1px solid #eef2ff; display:none; }
    textarea{ width:100%; min-height:120px; padding:8px; border-radius:6px; border:1px solid #e6eefc; font-family:monospace; }
    @media (max-width:900px){
      .container{ grid-template-columns:1fr; padding:0 12px; gap:12px; }
      #board-wrapper{ max-width:100%; }
      #board{ height:80vw; width:100%; aspect-ratio: auto; max-height:420px; }
      .resizer .range{ width:140px; }
      button { padding:10px 14px; font-size:15px; }
      .controls { flex-wrap:wrap; gap:12px; }
    }
    .multiplayer-panel { margin-top: 18px; display:flex; gap:12px; align-items:center; flex-wrap:wrap; justify-content:center; max-width:920px; }
    .multiplayer-panel input[type="text"] { padding:6px 8px; border-radius:6px; border:1px solid #e6eefc; }
    .multiplayer-panel select { padding:6px 8px; border-radius:6px; border:1px solid #e6eefc; }
    .status-bubble { padding:8px 10px; border-radius:8px; background:#f3f6ff; border:1px solid #e6eeff; color:#0b2; font-weight:600; }
    @media (pointer: coarse) { button { padding:10px 14px; font-size:15px; } .resizer .range { touch-action: pan-x; } }

    /* Highlight last move squares */
    .cb-last-move { outline: 3px solid rgba(255,200,0,0.95); outline-offset: -3px; box-shadow: inset 0 0 0 2px rgba(255,200,0,0.25); }

    /* Promotion modal */
    .promote-modal { position:fixed; left:50%; top:50%; transform:translate(-50%,-50%); background:#fff; border-radius:10px; padding:12px; box-shadow:0 10px 30px rgba(2,6,23,0.2); z-index:9999; display:none; }
    .promote-modal .row{ display:flex; gap:8px; align-items:center; justify-content:center; }
    .promote-modal button{ min-width:44px; min-height:44px; font-weight:700; }

    .readonly-note{ color:#444; font-size:13px; margin-left:8px; }
  </style>
</head>
<body>

  <!-- TOP BOARD SECTION -->
  <div class="board-top">
    <!-- controls row: buttons centered -->
    <div class="controls" aria-hidden="false">
      <button id="undoBtn">Undo</button>
      <button id="prevBtn">Previous</button>
      <button id="nextBtn">Next</button>
      <button id="flipBtn">Flip</button>
      <button id="resignBtn" title="Resign / Reset" style="background:#8b0f0f;">Resign</button>
    </div>

    <!-- resizer row moved below controls and centered -->
    <div class="resizer" aria-label="Board resizer controls" style="margin-top:6px;">
      <input id="boardSizeRange" class="range" type="range" min="240" max="1200" step="10" value="570" aria-label="Board size">
      <small id="boardSizeLabel">570px</small>
    </div>

    <div class="panel" style="width:100%; max-width:920px;">
      <div id="board-wrapper"><div id="board" aria-label="Chessboard container"></div></div>

      <div style="margin-top:10px; display:flex; justify-content:space-between; align-items:center;">
        <div style="margin:auto;">
          Orientation:
          <select id="orientationSelect"><option value="white">White</option><option value="black">Black</option></select>
        </div>
        <!-- FEN display intentionally removed as requested -->
      </div>
      <div class="info" id="msg" aria-live="polite"></div>
    </div>
  </div>

  <!-- two-column panels -->
  <div class="container" style="margin-top:18px;">
    <div style="display:flex; flex-direction:column; gap:12px;">
      <div class="panel">
        <div style="display:flex; justify-content:space-between; align-items:center;">
          <strong>PGN / FEN Input</strong>
          <div style="display:flex; gap:8px;">
            <button id="loadPgnBtn">Load PGN</button>
            <button id="showAnswerBtn">Show answer</button>
          </div>
        </div>
        <div style="margin-top:8px;">
          <textarea id="pgnInput" placeholder="Paste PGN or FEN here. Example PGN: 1. e4 e5 2. Nf3 Nc6"></textarea>
          <div style="display:flex; gap:8px; margin-top:8px;">
            <input type="file" id="pgnFile" accept=".pgn,text/plain">
            <button id="clearPgn">Clear</button>
            <button id="loadFenBtn">Load FEN</button>
            <button id="resetBtn">Reset</button>
          </div>
        </div>
      </div>
    </div>

    <div style="display:flex; flex-direction:column; gap:12px;">
      <div class="panel">
        <strong>Moves (hidden by default)</strong>
        <div id="movesList"></div>
      </div>
    </div>
  </div>

  <!-- multiplayer panel -->
  <div class="panel multiplayer-panel" style="margin-top:18px; max-width:920px;">
    <div style="display:flex; gap:8px; align-items:center;">
      <label for="emailInputBottom" class="small">Your email:</label>
      <input id="emailInputBottom" type="text" placeholder="example@gmail.com" />
      <label class="small"><input id="spectatorToggle" type="checkbox" /> Spectator</label>
      <button id="joinBtnBottom">Join Online</button>
    </div>

    <div style="display:flex; gap:8px; align-items:center;">
      <label class="small" for="onlinePlayersBottom">Online Players:</label>
      <select id="onlinePlayersBottom"></select>
      <button id="challengeBtnBottom">Challenge Player</button>
      <span class="readonly-note" id="readonlyNote" style="display:none;">Read-only mode</span>
    </div>

    <div style="margin-left:auto; display:flex; gap:8px; align-items:center;">
      <div id="multiplayStatus" class="muted">Not connected</div>
      <div id="pairedBubble" class="status-bubble" style="display:none;">Paired</div>
    </div>
  </div>

  <!-- promotion modal -->
  <div class="promote-modal" id="promoteModal" role="dialog" aria-modal="true">
    <div style="font-weight:700; text-align:center; margin-bottom:8px;">Choose promotion</div>
    <div class="row">
      <button data-piece="q">Q</button>
      <button data-piece="r">R</button>
      <button data-piece="b">B</button>
      <button data-piece="n">N</button>
    </div>
  </div>

  <!-- libs -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/chessboard-js/1.0.0/chessboard-1.0.0.min.js"></script>

  <!-- PGN parser -->
  <script>/* same parser omitted for brevity in this response - included in file */</script>

  <script>
  (function(){
    const CHESS_URL = 'https://iq4uchess.github.io/IQ4U-Chess-Classroom/js/libs/chess.min.js';
    const CUSTOM_PIECE_THEME = 'https://iq4uchess.github.io/IQ4U-Chess-Classroom/assets/pieces/cburnett/{piece}.svg';
    const FALLBACK_THEME = 'https://cdnjs.cloudflare.com/ajax/libs/chessboard-js/1.0.0/img/chesspieces/wikipedia/{piece}.png';

    // DOM
    const boardWrapper = document.getElementById('board-wrapper');
    const boardSizeRange = document.getElementById('boardSizeRange');
    const boardSizeLabel = document.getElementById('boardSizeLabel');
    const orientationSelect = document.getElementById('orientationSelect');
    const msgEl = document.getElementById('msg');
    const promoteModal = document.getElementById('promoteModal');
    const resignBtn = document.getElementById('resignBtn');

    // multiplayer UI
    const emailInputBottom = document.getElementById('emailInputBottom');
    const joinBtnBottom = document.getElementById('joinBtnBottom');
    const spectatorToggle = document.getElementById('spectatorToggle');
    const onlinePlayersBottom = document.getElementById('onlinePlayersBottom');
    const challengeBtnBottom = document.getElementById('challengeBtnBottom');
    const multiplayStatus = document.getElementById('multiplayStatus');
    const pairedBubble = document.getElementById('pairedBubble');
    const readonlyNote = document.getElementById('readonlyNote');

    // board state
    let board = null, game = null, currentTheme = FALLBACK_THEME;
    let isPaired = false, myColor = null, pairedGameId = null, isSpectator = false;
    let lastHighlighted = [];

    function setMsg(t, ms){ msgEl.textContent = t||''; if(ms>0) setTimeout(()=>{ if(msgEl.textContent===t) msgEl.textContent=''; }, ms); }

    async function chooseTheme(){
      const test = CUSTOM_PIECE_THEME.replace('{piece}','wP');
      try{ const res = await fetch(test,{method:'HEAD',cache:'no-store'}); return res.ok?CUSTOM_PIECE_THEME:FALLBACK_THEME;}catch(e){return FALLBACK_THEME}
    }

    // highlight helpers
    function clearHighlights(){ lastHighlighted.forEach(sq=>{ const el = document.querySelector('.square-'+sq); if(el) el.classList.remove('cb-last-move'); }); lastHighlighted=[]; }
    function highlightSquares(from,to){ clearHighlights(); const fromEl = document.querySelector('.square-'+from); const toEl = document.querySelector('.square-'+to); if(fromEl){ fromEl.classList.add('cb-last-move'); lastHighlighted.push(from); } if(toEl){ toEl.classList.add('cb-last-move'); lastHighlighted.push(to); }
      // remove after 3.5s
      setTimeout(()=> clearHighlights(), 3500);
    }

    function createBoard(theme){
      const orientation = (isPaired && myColor==='black') ? 'black' : orientationSelect.value || 'white';
      if(board && typeof board.destroy === 'function'){ try{ board.destroy(); }catch(e){} }
      board = Chessboard('board', {
        draggable: !isSpectator,
        position: game ? game.fen() : 'start',
        orientation: orientation,
        onDrop: onDrop,
        onSnapEnd: onSnapEnd,
        pieceTheme: theme
      });
    }

    function onSnapEnd(){ if(board) board.position(game.fen()); }

    // promotion UI
    let pendingPromo = null; // {from,to,resolve}
    function showPromotionDialog(){ promoteModal.style.display='block'; }
    function hidePromotionDialog(){ promoteModal.style.display='none'; }
    promoteModal.addEventListener('click', function(e){ if(e.target && e.target.dataset && e.target.dataset.piece){ const p = e.target.dataset.piece; if(pendingPromo && pendingPromo.resolve){ pendingPromo.resolve(p); } hidePromotionDialog(); }});

    // onDrop now supports promotion choice
    async function onDrop(source, target){
      if(!game) return 'snapback';

      if(isSpectator){ setMsg('Spectator — cannot move',1000); return 'snapback'; }

      // enforce color/turn
      if(isPaired && myColor){ const our = (myColor==='white')?'w':'b'; const piece = game.get(source); if(!piece){ setMsg('No piece at source',900); return 'snapback'; } if(piece.color !== our){ setMsg('That is not your piece',900); return 'snapback'; } if(game.turn() !== our){ setMsg('Not your turn',900); return 'snapback'; } }

      // check promotion possibility
      const legal = game.moves({ verbose:true });
      const candidate = legal.find(m => m.from === source && m.to === target && m.promotion);
      let chosenPromo = null;
      if(candidate){
        // ask user
        chosenPromo = await new Promise(resolve => { pendingPromo = { from:source, to:target, resolve }; showPromotionDialog(); });
        pendingPromo = null;
        if(!chosenPromo) chosenPromo='q';
      }

      const moveObj = { from: source, to: target };
      if(chosenPromo) moveObj.promotion = chosenPromo;

      const mv = game.move(moveObj);
      if(mv === null){ setMsg('Illegal move',900); return 'snapback'; }

      // update board
      if(board) board.position(game.fen());

      // emit move with metadata
      try{ if(window.firebaseMultiplayer && window.firebaseMultiplayer.emitMove){
        window.firebaseMultiplayer.emitMove({ fen: game.fen(), move: { from: mv.from, to: mv.to, san: mv.san, promotion: mv.promotion || null } });
      }}catch(e){}

      // highlight our move locally
      if(mv && mv.from && mv.to) highlightSquares(mv.from, mv.to);

      return;
    }

    // helper to apply remote messages (now may contain move metadata)
    window.onBoardMove = function(payload){
      try{
        if(!payload) return;
        const fen = (typeof payload === 'string') ? payload : payload.fen;
        const move = (typeof payload === 'object') ? payload.move : null;
        if(!fen) return;
        if(!game) game = new Chess();
        // avoid re-applying identical FEN
        if(game.fen() === fen) return;
        if(typeof game.load === 'function') game.load(fen);
        if(board) board.position(fen);
        if(move && move.from && move.to){ highlightSquares(move.from, move.to); }
      }catch(e){ console.warn('onBoardMove failed', e); }
    };

    // set board size
    function setBoardSize(px){ if(!px || isNaN(px)) return; const clamped = Math.max(240, Math.min(1200, Number(px))); boardWrapper.style.maxWidth = clamped + 'px'; boardSizeRange.value = clamped; boardSizeLabel.textContent = clamped + 'px'; try{ if(board && typeof board.resize === 'function'){ board.resize(); } else { createBoard(currentTheme); } }catch(e){ createBoard(currentTheme); } }

    // boot
    async function boot(){
      // load chess.js if needed
      if(typeof Chess === 'undefined'){
        try{ const mod = await import(CHESS_URL + '?t=' + Date.now()); window.Chess = mod.default || mod.Chess || mod; }catch(e){}
        if(typeof Chess === 'undefined'){ var s=document.createElement('script'); s.src=CHESS_URL+'?t='+Date.now(); s.async=false; document.head.appendChild(s); }
      }
      currentTheme = await chooseTheme();
      game = new Chess();
      isSpectator = false; // default until joined
      createBoard(currentTheme);

      // restore last game if present (reconnect recovery)
      const lastGame = localStorage.getItem('iq4u_last_game');
      const lastColor = localStorage.getItem('iq4u_last_color');
      if(lastGame){ // instruct firebase module to attach when ready
        const tryAttach = () => {
          if(window.firebaseMultiplayer && typeof window.firebaseMultiplayer.startWatchingGame === 'function'){
            window.firebaseMultiplayer.startWatchingGame(lastGame);
            pairedGameId = lastGame;
            isPaired = true;
            myColor = lastColor || null;
            isSpectator = !myColor;
            if(window.firebaseMultiplayer.getMyColor) window.firebaseMultiplayer.getMyColor = ()=> myColor;
            pairedBubble.style.display='inline-block';
            multiplayStatus.textContent = 'Reattached to game';
            createBoard(currentTheme);
            return true;
          }
          return false;
        };
        let tries=0; const t = setInterval(()=>{ tries++; if(tryAttach() || tries>20) clearInterval(t); }, 400);
      }

      // initial size: read from #board-wrapper (we set it via CSS to 570px)
      const initial = parseInt(getComputedStyle(boardWrapper).maxWidth,10) || boardWrapper.clientWidth || 570;
      setBoardSize(initial);
    }
    boot();

    // UI wiring
    document.getElementById('flipBtn').addEventListener('click', ()=>{ if(board) board.flip(); });
    orientationSelect.onchange = ()=> { if(board) createBoard(currentTheme); };
    boardSizeRange.addEventListener('input', (e)=> setBoardSize(e.target.value));

    // Resign handler: reset board locally + notify opponent if possible
    resignBtn.addEventListener('click', ()=>{
      if(!game) return;
      game.reset();
      if(board) board.position('start');
      clearHighlights();
      setMsg('You resigned — game reset',1500);

      try{
        if(window.firebaseMultiplayer && window.firebaseMultiplayer.emitMove){
          window.firebaseMultiplayer.emitMove({ type:'resign', by: window.firebaseMultiplayer.getMyId ? window.firebaseMultiplayer.getMyId() : null });
        }
      }catch(e){ console.warn('resign notify failed', e); }

      isPaired = false;
      myColor = null;
      pairedGameId = null;
      isSpectator = false;
      pairedBubble.style.display='none';
      multiplayStatus.textContent = 'Not connected';
      readonlyNote.style.display = 'none';
      try{ localStorage.removeItem('iq4u_last_game'); localStorage.removeItem('iq4u_last_color'); }catch(e){}
      createBoard(currentTheme);
    });

    // other UI and firebase code (unchanged)...
    // omitted here for brevity in this snippet — include your existing firebase and PGN logic as before.

    window.game = game;

  })();
  </script>

  <!-- FIREBASE code should remain unchanged; include the same blocks you already have below -->
  <!-- ... -->
</body>
</html>

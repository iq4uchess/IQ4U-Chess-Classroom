<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>IQ4U â€” Student Board</title>

  <!-- Chessboard.js CSS -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/chessboard-js/1.0.0/chessboard-1.0.0.min.css" />

  <style>
    body{ font-family: Arial, sans-serif; margin:16px; background:#f6f7fb; color:#111; }
    .controls{ display:flex; justify-content:flex-end; gap:8px; margin-bottom:12px; }
    button{ padding:8px 12px; border:none; background:#0f172a; color:#fff; border-radius:8px; cursor:pointer; }
    .container{ display:grid; grid-template-columns:420px 1fr; gap:18px; align-items:start; }
    #board{ width:400px; }
    .panel{ background:#fff; padding:12px; border-radius:8px; box-shadow:0 6px 18px rgba(2,6,23,.04); }
    #movesList{ min-height:220px; max-height:300px; overflow:auto; padding:8px; border-radius:6px; background:#fbfdff; border:1px solid #eef2ff; }
    textarea{ width:100%; min-height:120px; padding:8px; border-radius:6px; border:1px solid #e6eefc; font-family:monospace; }
    .errorBox{ background:#ffefef; border:1px solid #ffd6d6; color:#7a1f1f; padding:8px; border-radius:6px; margin-bottom:12px; display:none; }
    @media (max-width:900px){ .container{ grid-template-columns:1fr; } #board{ width:100%; } .controls{ justify-content:center; } }
  </style>
</head>
<body>

  <div id="errorBox" class="errorBox"></div>

  <div class="controls">
    <button id="undoBtn">Undo</button>
    <button id="prevBtn">Previous</button>
    <button id="nextBtn">Next</button>
    <button id="flipBtn">Flip</button>
  </div>

  <div class="container">
    <div class="panel">
      <div id="board"></div>
      <div style="margin-top:10px; display:flex; justify-content:space-between; align-items:center;">
        <div>Orientation:
          <select id="orientationSelect">
            <option value="white">White</option>
            <option value="black">Black</option>
          </select>
        </div>
        <div>FEN: <code id="fenDisplay" style="font-family:monospace;"></code></div>
      </div>
    </div>

    <div style="display:flex; flex-direction:column; gap:12px;">
      <div class="panel">
        <div style="display:flex; justify-content:space-between; align-items:center;">
          <strong>PGN / FEN Input</strong>
          <button id="loadPgnBtn">Load PGN</button>
        </div>
        <div style="margin-top:8px;">
          <textarea id="pgnInput" placeholder="Paste PGN or FEN here. Example PGN: 1. e4 e5 2. Nf3 Nc6"></textarea>
          <div style="display:flex; gap:8px; margin-top:8px;">
            <button id="clearPgn">Clear</button>
            <button id="loadFenBtn">Load FEN</button>
            <button id="resetBtn">Reset</button>
          </div>
        </div>
      </div>

      <div class="panel">
        <strong>Moves</strong>
        <div id="movesList"></div>
      </div>
    </div>
  </div>

  <!-- jQuery -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

  <!-- LOCAL absolute Chess.js (GitHub Pages URL) -->
  <script src="https://iq4uchess.github.io/IQ4U-Chess-Classroom/js/libs/chess.min.js"></script>

  <!-- Chessboard.js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/chessboard-js/1.0.0/chessboard-1.0.0.min.js"></script>

  <script>
    const errorBox = document.getElementById('errorBox');

    function showError(msg){
      errorBox.style.display = 'block';
      errorBox.textContent = msg;
      console.error(msg);
    }

    // Check libraries
    if (typeof Chess === 'undefined') {
      showError('Chess.js failed to load from: https://iq4uchess.github.io/IQ4U-Chess-Classroom/js/libs/chess.min.js');
      throw new Error('Chess.js not loaded');
    }

    if (typeof Chessboard === 'undefined') {
      showError('Chessboard.js failed to load from CDN.');
      throw new Error('Chessboard.js not loaded');
    }

    (function(){
      const game = new Chess();
      let board = null;
      let pgnMoves = [];
      let stepIndex = 0;
      let orientation = document.getElementById('orientationSelect').value || 'white';

      function updateFen(){ document.getElementById('fenDisplay').textContent = game.fen(); }

      function refreshMoves(){
        const hist = game.history();
        let html = '';
        if (pgnMoves.length > 0){
          html += '<div style="display:flex;flex-wrap:wrap;gap:6px;margin-bottom:8px">';
          for (let i=0;i<pgnMoves.length;i++){
            const cls = (i < stepIndex) ? 'style="padding:6px;border-radius:6px;background:#e6f0ff;font-weight:600;"' :
                                          'style="padding:6px;border-radius:6px;"';
            html += `<div ${cls}>${pgnMoves[i]}</div>`;
          }
          html += '</div><hr>';
        }
        for (let i=0;i<hist.length;i+=2){
          const no = Math.floor(i/2)+1;
          html += `<div style="padding:6px;border-radius:6px;"><strong>${no}.</strong> ${hist[i]||''} ${hist[i+1]||''}</div>`;
        }
        document.getElementById('movesList').innerHTML = html || '<div>No moves yet.</div>';
      }

      function onDrop(source, target){
        const move = game.move({ from: source, to: target, promotion:'q' });
        if (move === null) return 'snapback';
        pgnMoves = []; stepIndex = 0;
        updateFen(); refreshMoves();
      }

      function onSnapEnd(){ board.position(game.fen()); }

      function initBoard(){
        board = Chessboard('board', {
          draggable:true,
          position:'start',
          orientation: orientation,
          onDrop:onDrop,
          onSnapEnd:onSnapEnd,
          pieceTheme:'https://cdnjs.cloudflare.com/ajax/libs/chessboard-js/1.0.0/img/chesspieces/wikipedia/{piece}.png'
        });
        updateFen(); refreshMoves();
      }

      document.getElementById('undoBtn').onclick = () => {
        game.undo(); board.position(game.fen());
        updateFen(); refreshMoves();
      };
      document.getElementById('flipBtn').onclick = () => board.flip();
      document.getElementById('resetBtn').onclick = () => {
        game.reset(); pgnMoves=[]; stepIndex=0;
        board.position('start'); updateFen(); refreshMoves();
      };
      document.getElementById('clearPgn').onclick = () => document.getElementById('pgnInput').value='';
      document.getElementById('orientationSelect').onchange = function(){
        orientation=this.value; initBoard();
      };

      document.getElementById('loadFenBtn').onclick = () => {
        const txt = document.getElementById('pgnInput').value.trim();
        if (!txt){ alert('Paste FEN first'); return; }
        if (!game.load(txt)){ alert('Invalid FEN'); return; }
        pgnMoves=[]; stepIndex=0; board.position(game.fen());
        updateFen(); refreshMoves();
      };

      document.getElementById('loadPgnBtn').onclick = () => {
        const pgn = document.getElementById('pgnInput').value.trim();
        if (!pgn){ alert('Paste PGN first'); return; }
        const tmp = new Chess();
        let ok = true;
        try{
          ok = tmp.load_pgn ? tmp.load_pgn(pgn) :
               tmp.loadPgn ? tmp.loadPgn(pgn) :
               tmp.load(pgn);
        }catch(e){ ok=false; }

        if (!ok){ alert('Invalid PGN'); return; }

        pgnMoves = tmp.history();
        stepIndex = 0;
        game.reset();
        board.position('start');
        updateFen(); refreshMoves();
      };

      document.getElementById('nextBtn').onclick = () => {
        if (stepIndex >= pgnMoves.length) return;
        const m = game.move(pgnMoves[stepIndex], {sloppy:true});
        if (!m){ alert('Could not apply move'); return; }
        stepIndex++;
        board.position(game.fen());
        updateFen(); refreshMoves();
      };

      document.getElementById('prevBtn').onclick = () => {
        if (stepIndex <= 0) return;
        game.undo(); stepIndex--;
        board.position(game.fen());
        updateFen(); refreshMoves();
      };

      initBoard();
    })();
  </script>
</body>
</html>
